{
  "name": "Marketing Calculator - Quote Request V6",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "calculateur-marketing",
        "options": {}
      },
      "id": "3b540cef-5494-4956-adeb-50daa27725fb",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [300, 500],
      "webhookId": "calculateur-marketing-form"
    },
    {
      "parameters": {
        "jsCode": "// Generate detailed HTML from departmentBreakdown\nconst data = $input.first().json.body;\nconst breakdown = data.departmentBreakdown || [];\nconst pricing = data.pricing || {};\nconst contact = data.contact || {};\nconst lang = data.metadata?.lang || 'fr';\nconst duration = data.duration || 4;\n\n// Translation helper\nconst tr = (fr, en) => lang === 'fr' ? fr : en;\n\n// Helper function to format price\nconst formatPrice = (price) => Math.round(price).toLocaleString('fr-FR');\n\n// Department colors based on ID\nconst deptColors = {\n  'seo': { bg: '#EEF2FF', border: '#818CF8', text: '#4F46E5', icon: '#6366F1' },\n  'google-ads': { bg: '#EFF6FF', border: '#60A5FA', text: '#2563EB', icon: '#3B82F6' },\n  'paid-social': { bg: '#F5F3FF', border: '#A78BFA', text: '#7C3AED', icon: '#8B5CF6' },\n  'emailing': { bg: '#FFFBEB', border: '#FBBF24', text: '#D97706', icon: '#F59E0B' },\n  'ai-training': { bg: '#ECFDF5', border: '#34D399', text: '#059669', icon: '#10B981' },\n  'ai-solutions': { bg: '#F5F3FF', border: '#A78BFA', text: '#7C3AED', icon: '#8B5CF6' },\n  'tracking': { bg: '#ECFEFF', border: '#22D3EE', text: '#0891B2', icon: '#06B6D4' }\n};\n\nconst defaultColors = { bg: '#F9FAFB', border: '#D1D5DB', text: '#374151', icon: '#6B7280' };\n\n// Generate department HTML blocks\nlet departmentsHtml = '';\nlet totalMonthly = 0;\nlet totalOneOff = 0;\nlet totalMediaBudget = 0;\n\n// If no breakdown, generate from selections\nif (breakdown.length === 0 && data.selectedDomains) {\n  departmentsHtml = `<p style=\"color: #6B7280; font-style: italic;\">${tr('Voir le dÃ©tail dans le JSON ci-dessous.', 'See details in JSON below.')}</p>`;\n} else {\n  breakdown.forEach(dept => {\n    const colors = deptColors[dept.id] || defaultColors;\n    \n    if (dept.isNotSure) {\n      departmentsHtml += `\n        <div style=\"background: #FEF3C7; border: 2px solid #F59E0B; border-radius: 12px; padding: 16px; margin-bottom: 16px;\">\n          <div style=\"display: flex; align-items: center; gap: 12px;\">\n            <span style=\"font-size: 24px;\">${dept.icon}</span>\n            <div style=\"flex: 1;\">\n              <h3 style=\"margin: 0; color: #92400E; font-size: 16px; font-weight: 600;\">${dept.name}</h3>\n              <p style=\"margin: 4px 0 0 0; color: #B45309; font-size: 14px;\">ðŸ’¬ ${tr('Ã€ discuter ensemble', 'To discuss together')}</p>\n            </div>\n          </div>\n        </div>\n      `;\n      return;\n    }\n    \n    let servicesHtml = '';\n    (dept.services || []).forEach(service => {\n      const priceText = service.price > 0 \n        ? `${formatPrice(service.price)}â‚¬${service.isOneOff ? '' : tr('/mois', '/month')}` \n        : (service.level || '');\n      servicesHtml += `\n        <tr>\n          <td style=\"padding: 8px 12px; border-bottom: 1px solid #E5E7EB; color: #374151; font-size: 14px;\">\n            ${service.name}${service.level && service.price > 0 ? ` <span style=\"color: #6B7280; font-size: 12px;\">(${service.level})</span>` : ''}\n          </td>\n          <td style=\"padding: 8px 12px; border-bottom: 1px solid #E5E7EB; text-align: right; font-weight: 500; color: ${colors.text}; font-size: 14px;\">\n            ${priceText}\n          </td>\n        </tr>\n      `;\n    });\n    \n    if (dept.managementFee > 0) {\n      servicesHtml += `\n        <tr>\n          <td style=\"padding: 8px 12px; border-bottom: 1px solid #E5E7EB; color: #374151; font-size: 14px;\">\n            ${tr('Frais de gestion publicitaire', 'Ad management fee')}\n          </td>\n          <td style=\"padding: 8px 12px; border-bottom: 1px solid #E5E7EB; text-align: right; font-weight: 500; color: ${colors.text}; font-size: 14px;\">\n            ${formatPrice(dept.managementFee)}â‚¬${tr('/mois', '/month')}\n          </td>\n        </tr>\n      `;\n    }\n    \n    if (dept.mediaBudget > 0) {\n      servicesHtml += `\n        <tr>\n          <td style=\"padding: 8px 12px; border-bottom: 1px solid #E5E7EB; color: #F59E0B; font-size: 14px;\">\n            ${tr('Budget mÃ©dia (non inclus)', 'Media budget (not included)')}\n          </td>\n          <td style=\"padding: 8px 12px; border-bottom: 1px solid #E5E7EB; text-align: right; font-weight: 500; color: #F59E0B; font-size: 14px;\">\n            ${formatPrice(dept.mediaBudget)}â‚¬${tr('/mois', '/month')}\n          </td>\n        </tr>\n      `;\n      totalMediaBudget += dept.mediaBudget;\n    }\n    \n    totalMonthly += (dept.monthlySubtotal || 0);\n    totalOneOff += (dept.oneOffSubtotal || 0);\n    \n    let subtotalHtml = '';\n    if ((dept.monthlySubtotal || 0) > 0 || (dept.oneOffSubtotal || 0) > 0) {\n      const parts = [];\n      if (dept.monthlySubtotal > 0) parts.push(`${formatPrice(dept.monthlySubtotal)}â‚¬${tr('/mois', '/month')}`);\n      if (dept.oneOffSubtotal > 0) parts.push(`${formatPrice(dept.oneOffSubtotal)}â‚¬ one-off`);\n      \n      subtotalHtml = `\n        <tr style=\"background: ${colors.bg};\">\n          <td style=\"padding: 10px 12px; font-weight: 600; color: ${colors.text}; font-size: 14px;\">\n            ${tr('Sous-total', 'Subtotal')} ${dept.name}\n          </td>\n          <td style=\"padding: 10px 12px; text-align: right; font-weight: 700; color: ${colors.text}; font-size: 15px;\">\n            ${parts.join(' + ')}\n          </td>\n        </tr>\n      `;\n    }\n    \n    departmentsHtml += `\n      <div style=\"background: white; border: 2px solid ${colors.border}; border-radius: 12px; overflow: hidden; margin-bottom: 16px;\">\n        <div style=\"background: ${colors.bg}; padding: 14px 16px; border-bottom: 1px solid ${colors.border};\">\n          <div style=\"display: flex; align-items: center; gap: 12px;\">\n            <span style=\"font-size: 28px;\">${dept.icon}</span>\n            <h3 style=\"margin: 0; color: ${colors.text}; font-size: 18px; font-weight: 700;\">${dept.name}</h3>\n          </div>\n        </div>\n        <table style=\"width: 100%; border-collapse: collapse;\">\n          ${servicesHtml}\n          ${subtotalHtml}\n        </table>\n      </div>\n    `;\n  });\n}\n\nconst discountPct = pricing.discountPercentage || 0;\nconst monthlyAfterDiscount = pricing.monthlyAfterDiscount || 0;\nconst grandTotal = pricing.grandTotalWithoutBudget || 0;\n\nlet totalsHtml = `\n  <div style=\"background: linear-gradient(135deg, #1e3a5f 0%, #3b82f6 100%); border-radius: 12px; padding: 24px; color: white; margin-top: 24px;\">\n    <h3 style=\"margin: 0 0 16px 0; font-size: 18px; font-weight: 600; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 12px;\">ðŸ’° ${tr('RÃ©capitulatif financier', 'Financial Summary')}</h3>\n    <table style=\"width: 100%; border-collapse: collapse;\">\n`;\n\nif ((pricing.monthlyTotal || totalMonthly) > 0) {\n  totalsHtml += `<tr><td style=\"padding: 8px 0; color: rgba(255,255,255,0.85); font-size: 14px;\">${tr('Services mensuels', 'Monthly services')}</td><td style=\"padding: 8px 0; text-align: right; font-weight: 500; font-size: 14px;\">${formatPrice(pricing.monthlyTotal || totalMonthly)}â‚¬${tr('/mois', '/month')}</td></tr>`;\n}\nif (discountPct > 0) {\n  totalsHtml += `<tr><td style=\"padding: 8px 0; color: #86EFAC; font-size: 14px;\">${tr('Remise engagement', 'Commitment discount')} ${duration} ${tr('mois', 'months')}</td><td style=\"padding: 8px 0; text-align: right; color: #86EFAC; font-weight: 500; font-size: 14px;\">-${discountPct}%</td></tr>`;\n}\nif (monthlyAfterDiscount > 0) {\n  totalsHtml += `<tr><td style=\"padding: 8px 0; color: rgba(255,255,255,0.85); font-size: 14px; font-weight: 600;\">${tr('Mensuel aprÃ¨s remise', 'Monthly after discount')}</td><td style=\"padding: 8px 0; text-align: right; font-weight: 700; font-size: 16px;\">${formatPrice(monthlyAfterDiscount)}â‚¬${tr('/mois', '/month')}</td></tr>`;\n}\nif ((pricing.oneOffTotal || totalOneOff) > 0) {\n  totalsHtml += `<tr><td style=\"padding: 8px 0; color: rgba(255,255,255,0.85); font-size: 14px;\">${tr('Services one-off', 'One-time services')}</td><td style=\"padding: 8px 0; text-align: right; font-weight: 500; font-size: 14px;\">${formatPrice(pricing.oneOffTotal || totalOneOff)}â‚¬</td></tr>`;\n}\nif ((pricing.adBudgetTotal || totalMediaBudget) > 0) {\n  totalsHtml += `<tr><td style=\"padding: 8px 0; color: #FCD34D; font-size: 14px;\">${tr('Budget mÃ©dia (non inclus)', 'Media budget (not included)')}</td><td style=\"padding: 8px 0; text-align: right; color: #FCD34D; font-weight: 500; font-size: 14px;\">${formatPrice(pricing.adBudgetTotal || totalMediaBudget)}â‚¬${tr('/mois', '/month')}</td></tr>`;\n}\ntotalsHtml += `<tr style=\"border-top: 2px solid rgba(255,255,255,0.3);\"><td style=\"padding: 16px 0 8px 0; font-size: 18px; font-weight: 700;\">TOTAL (${duration} ${tr('mois', 'months')})</td><td style=\"padding: 16px 0 8px 0; text-align: right; font-size: 28px; font-weight: 800;\">${grandTotal > 0 ? formatPrice(grandTotal) + 'â‚¬' : tr('Ã€ discuter', 'To discuss')}</td></tr></table></div>`;\n\n// Generate printable HTML document with better header\nconst timestamp = new Date().toLocaleString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });\nconst quoteDate = new Date().toLocaleDateString(lang === 'fr' ? 'fr-FR' : 'en-GB', { day: '2-digit', month: 'long', year: 'numeric' });\n\nlet printableBreakdownHtml = '';\nif (breakdown.length > 0) {\n  printableBreakdownHtml = breakdown.map(dept => {\n    const colors = deptColors[dept.id] || defaultColors;\n    if (dept.isNotSure) {\n      return `<div style=\"background: #FEF3C7; border: 2px solid #F59E0B; border-radius: 12px; padding: 20px; margin-bottom: 20px;\"><div style=\"display: flex; align-items: center; gap: 12px;\"><span style=\"font-size: 24px;\">${dept.icon}</span><div><h3 style=\"margin: 0; color: #92400E;\">${dept.name}</h3><p style=\"margin: 4px 0 0 0; color: #B45309;\">ðŸ’¬ ${tr('Ã€ discuter ensemble', 'To discuss together')}</p></div></div></div>`;\n    }\n    let rows = (dept.services || []).map(s => `<tr><td style=\"padding: 10px 20px; border-top: 1px solid #E5E7EB; color: #374151;\">${s.name}${s.level && s.price > 0 ? ` <span style=\"color: #6B7280; font-size: 12px;\">(${s.level})</span>` : ''}</td><td style=\"padding: 10px 20px; border-top: 1px solid #E5E7EB; text-align: right; font-weight: 500; color: ${colors.text};\">${s.price > 0 ? formatPrice(s.price) + 'â‚¬' + (s.isOneOff ? '' : tr('/mois', '/month')) : s.level}</td></tr>`).join('');\n    if (dept.managementFee > 0) rows += `<tr><td style=\"padding: 10px 20px; border-top: 1px solid #E5E7EB; color: #374151;\">${tr('Frais de gestion', 'Management fee')}</td><td style=\"padding: 10px 20px; border-top: 1px solid #E5E7EB; text-align: right; font-weight: 500; color: ${colors.text};\">${formatPrice(dept.managementFee)}â‚¬${tr('/mois', '/month')}</td></tr>`;\n    if (dept.mediaBudget > 0) rows += `<tr><td style=\"padding: 10px 20px; border-top: 1px solid #E5E7EB; color: #F59E0B;\">${tr('Budget mÃ©dia (non inclus)', 'Media budget (not included)')}</td><td style=\"padding: 10px 20px; border-top: 1px solid #E5E7EB; text-align: right; font-weight: 500; color: #F59E0B;\">${formatPrice(dept.mediaBudget)}â‚¬${tr('/mois', '/month')}</td></tr>`;\n    const parts = [];\n    if (dept.monthlySubtotal > 0) parts.push(formatPrice(dept.monthlySubtotal) + 'â‚¬' + tr('/mois', '/month'));\n    if (dept.oneOffSubtotal > 0) parts.push(formatPrice(dept.oneOffSubtotal) + 'â‚¬ one-off');\n    if (parts.length > 0) rows += `<tr style=\"background: ${colors.bg};\"><td style=\"padding: 10px 20px; font-weight: 600; color: ${colors.text};\">${tr('Sous-total', 'Subtotal')} ${dept.name}</td><td style=\"padding: 10px 20px; text-align: right; font-weight: 700; color: ${colors.text};\">${parts.join(' + ')}</td></tr>`;\n    return `<div style=\"border: 2px solid ${colors.border}; border-radius: 12px; margin-bottom: 20px; overflow: hidden;\"><div style=\"background: ${colors.bg}; padding: 16px 20px; display: flex; align-items: center; gap: 12px;\"><span style=\"font-size: 28px;\">${dept.icon}</span><h3 style=\"margin: 0; color: ${colors.text}; font-size: 18px; font-weight: 700;\">${dept.name}</h3></div><table style=\"width: 100%; border-collapse: collapse;\">${rows}</table></div>`;\n  }).join('');\n} else {\n  printableBreakdownHtml = `<p style=\"color: #6B7280; font-style: italic;\">${tr('DÃ©tails Ã  confirmer lors de notre Ã©change.', 'Details to confirm during our discussion.')}</p>`;\n}\n\nconst printableHtml = `<!DOCTYPE html>\n<html lang=\"${lang}\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>${tr('Devis MyDigipal', 'MyDigipal Quote')} - ${contact.company || 'Client'}</title>\n  <style>\n    @media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }\n    body { font-family: 'Segoe UI', Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 40px; color: #1F2937; line-height: 1.6; }\n    .header { background: linear-gradient(135deg, #1e3a5f 0%, #3b82f6 100%); border-radius: 16px; padding: 30px 40px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }\n    .header-left { display: flex; flex-direction: column; gap: 8px; }\n    .header-title { color: white; font-size: 32px; font-weight: 800; margin: 0; letter-spacing: -0.5px; }\n    .header-subtitle { color: rgba(255,255,255,0.8); font-size: 14px; margin: 0; }\n    .header-right { text-align: right; color: white; }\n    .header-right p { margin: 4px 0; font-size: 13px; color: rgba(255,255,255,0.9); }\n    .header-ref { font-weight: 600; font-size: 14px !important; }\n    .client-section { background: #F8FAFC; padding: 24px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #E2E8F0; }\n    .client-section h2 { color: #3b82f6; margin: 0 0 16px 0; font-size: 18px; }\n    .totals-section { background: linear-gradient(135deg, #1e3a5f 0%, #3b82f6 100%); color: white; border-radius: 12px; padding: 30px; margin-top: 30px; }\n    .totals-section h3 { margin: 0 0 20px 0; font-size: 20px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 12px; }\n    .totals-table { width: 100%; border-collapse: collapse; }\n    .totals-table td { padding: 10px 0; }\n    .totals-table .grand-total td { border-top: 2px solid rgba(255,255,255,0.3); padding-top: 20px; }\n    .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #E5E7EB; text-align: center; color: #6B7280; font-size: 12px; }\n    .validity { background: #F0F9FF; border-left: 4px solid #3b82f6; padding: 16px 20px; margin-top: 30px; border-radius: 0 8px 8px 0; }\n  </style>\n</head>\n<body>\n  <div class=\"header\">\n    <div class=\"header-left\">\n      <h1 class=\"header-title\">MyDigipal</h1>\n      <p class=\"header-subtitle\">Digital Marketing Agency</p>\n    </div>\n    <div class=\"header-right\">\n      <p style=\"font-size: 20px !important; font-weight: 700; margin-bottom: 8px !important;\">${tr('DEVIS', 'QUOTE')}</p>\n      <p>${tr('Date', 'Date')}: ${quoteDate}</p>\n      <p class=\"header-ref\">${tr('RÃ©f', 'Ref')}: MDQ-${Date.now().toString(36).toUpperCase()}</p>\n    </div>\n  </div>\n\n  <div class=\"client-section\">\n    <h2>ðŸ‘¤ Client</h2>\n    <table style=\"width: 100%;\">\n      <tr><td style=\"padding: 8px 0; font-weight: 600; color: #64748B; width: 120px;\">${tr('Entreprise', 'Company')}:</td><td>${contact.company || '-'}</td></tr>\n      <tr><td style=\"padding: 8px 0; font-weight: 600; color: #64748B;\">Contact:</td><td>${contact.name}</td></tr>\n      <tr><td style=\"padding: 8px 0; font-weight: 600; color: #64748B;\">Email:</td><td>${contact.email}</td></tr>\n      <tr><td style=\"padding: 8px 0; font-weight: 600; color: #64748B;\">${tr('DurÃ©e', 'Duration')}:</td><td>${duration} ${tr('mois', 'months')}${discountPct > 0 ? ` (-${discountPct}%)` : ''}</td></tr>\n    </table>\n  </div>\n\n  <h2 style=\"color: #1F2937; margin-bottom: 20px;\">ðŸ“‹ ${tr('DÃ©tail des services', 'Services Breakdown')}</h2>\n  ${printableBreakdownHtml}\n\n  <div class=\"totals-section\">\n    <h3>ðŸ’° ${tr('RÃ©capitulatif financier', 'Financial Summary')}</h3>\n    <table class=\"totals-table\">\n      ${(pricing.monthlyTotal || totalMonthly) > 0 ? `<tr><td style=\"color: rgba(255,255,255,0.85);\">${tr('Services mensuels', 'Monthly services')}</td><td style=\"text-align: right; font-weight: 500;\">${formatPrice(pricing.monthlyTotal || totalMonthly)}â‚¬${tr('/mois', '/month')}</td></tr>` : ''}\n      ${discountPct > 0 ? `<tr><td style=\"color: #86EFAC;\">${tr('Remise engagement', 'Discount')} ${duration} ${tr('mois', 'months')}</td><td style=\"text-align: right; color: #86EFAC; font-weight: 500;\">-${discountPct}%</td></tr>` : ''}\n      ${monthlyAfterDiscount > 0 ? `<tr><td style=\"color: rgba(255,255,255,0.85); font-weight: 600;\">${tr('Mensuel aprÃ¨s remise', 'Monthly after discount')}</td><td style=\"text-align: right; font-weight: 700;\">${formatPrice(monthlyAfterDiscount)}â‚¬${tr('/mois', '/month')}</td></tr>` : ''}\n      ${(pricing.oneOffTotal || totalOneOff) > 0 ? `<tr><td style=\"color: rgba(255,255,255,0.85);\">${tr('Services one-off', 'One-time services')}</td><td style=\"text-align: right; font-weight: 500;\">${formatPrice(pricing.oneOffTotal || totalOneOff)}â‚¬</td></tr>` : ''}\n      ${(pricing.adBudgetTotal || totalMediaBudget) > 0 ? `<tr><td style=\"color: #FCD34D;\">${tr('Budget mÃ©dia (non inclus)', 'Media budget (not included)')}</td><td style=\"text-align: right; color: #FCD34D; font-weight: 500;\">${formatPrice(pricing.adBudgetTotal || totalMediaBudget)}â‚¬${tr('/mois', '/month')}</td></tr>` : ''}\n      <tr class=\"grand-total\"><td style=\"font-size: 20px; font-weight: 700;\">TOTAL (${duration} ${tr('mois', 'months')})</td><td style=\"text-align: right; font-size: 32px; font-weight: 800;\">${grandTotal > 0 ? formatPrice(grandTotal) + 'â‚¬' : tr('Ã€ discuter', 'To discuss')}</td></tr>\n    </table>\n  </div>\n\n  <div class=\"validity\">\n    <strong>${tr('ValiditÃ© du devis', 'Quote validity')}:</strong> ${tr('Ce devis est valable 30 jours Ã  compter de sa date d\\'Ã©mission.', 'This quote is valid for 30 days from the date of issue.')}\n  </div>\n\n  <div class=\"footer\">\n    <p><strong>MyDigipal</strong> - Digital Marketing Agency</p>\n    <p>paul@mydigipal.com | www.mydigipal.com</p>\n    <p>Â© 2025 MyDigipal - ${tr('Tous droits rÃ©servÃ©s', 'All rights reserved')}</p>\n  </div>\n</body>\n</html>`;\n\nreturn {\n  json: {\n    ...data,\n    departmentsHtml,\n    totalsHtml,\n    printableHtml,\n    timestamp,\n    langFlag: lang === 'en' ? 'ðŸ‡¬ðŸ‡§ EN' : 'ðŸ‡«ðŸ‡· FR',\n    monthlyAfterDiscount: formatPrice(monthlyAfterDiscount),\n    grandTotal: grandTotal > 0 ? formatPrice(grandTotal) : tr('Ã€ discuter', 'To discuss'),\n    grandTotalNum: grandTotal,\n    hasNotSure: breakdown.some(d => d.isNotSure) || Object.values(data.notSureAbout || {}).some(v => v),\n    notSureList: breakdown.filter(d => d.isNotSure).map(d => d.name).join(', ') || Object.keys(data.notSureAbout || {}).filter(k => data.notSureAbout[k]).join(', '),\n    // For Google Sheets\n    sheetTimestamp: new Date().toISOString(),\n    sheetDomains: data.selectedDomains?.join(', ') || '',\n    sheetNotSure: breakdown.filter(d => d.isNotSure).map(d => d.name).join(', ') || Object.keys(data.notSureAbout || {}).filter(k => data.notSureAbout[k]).join(', '),\n    sheetBreakdownJson: JSON.stringify(breakdown)\n  }\n};"
      },
      "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
      "name": "Generate Email HTML",
      "type": "n8n-nodes-base.code",
      "position": [520, 500],
      "typeVersion": 2
    },
    {
      "parameters": {
        "sendTo": "paul@mydigipal.com",
        "subject": "=ðŸ”” Nouveau lead: {{ $json.contact.name }} ({{ $json.contact.company }}) - {{ $json.grandTotal }}â‚¬",
        "message": "=<div style=\"font-family: 'Segoe UI', Arial, sans-serif; max-width: 700px; margin: 0 auto;\">\n\n<!-- Header -->\n<div style=\"background: linear-gradient(135deg, #1e3a5f 0%, #3b82f6 100%); padding: 25px 30px; border-radius: 12px 12px 0 0;\">\n<h2 style=\"color: white; margin: 0; font-size: 22px;\">ðŸŽ¯ Nouveau lead depuis le calculateur</h2>\n<p style=\"color: rgba(255,255,255,0.9); margin: 8px 0 0 0; font-size: 14px;\">{{ $json.timestamp }} | Langue: {{ $json.langFlag }}</p>\n</div>\n\n<!-- Main Content -->\n<div style=\"background: #fff; padding: 30px; border: 1px solid #E5E7EB; border-top: none; border-radius: 0 0 12px 12px;\">\n\n<!-- Contact Section -->\n<div style=\"background: #F8FAFC; padding: 20px; border-radius: 10px; margin-bottom: 25px;\">\n<h3 style=\"color: #3b82f6; margin: 0 0 15px 0; font-size: 16px;\">ðŸ‘¤ Contact</h3>\n<table style=\"width: 100%; border-collapse: collapse;\">\n<tr><td style=\"padding: 10px 15px; background: white; border-radius: 6px 0 0 0; width: 130px; font-weight: 600; color: #64748B; font-size: 13px;\">Nom</td><td style=\"padding: 10px 15px; background: white; border-radius: 0 6px 0 0; color: #1F2937; font-size: 14px;\">{{ $json.contact.name }}</td></tr>\n<tr><td style=\"padding: 10px 15px; background: white; font-weight: 600; color: #64748B; font-size: 13px;\">Email</td><td style=\"padding: 10px 15px; background: white;\"><a href=\"mailto:{{ $json.contact.email }}\" style=\"color: #3b82f6; text-decoration: none; font-size: 14px;\">{{ $json.contact.email }}</a></td></tr>\n<tr><td style=\"padding: 10px 15px; background: white; font-weight: 600; color: #64748B; font-size: 13px;\">Entreprise</td><td style=\"padding: 10px 15px; background: white; color: #1F2937; font-size: 14px;\">{{ $json.contact.company }}</td></tr>\n<tr><td style=\"padding: 10px 15px; background: white; border-radius: 0 0 0 6px; font-weight: 600; color: #64748B; font-size: 13px;\">DurÃ©e</td><td style=\"padding: 10px 15px; background: white; border-radius: 0 0 6px 0; color: #1F2937; font-size: 14px;\">{{ $json.duration }} mois{{ $json.pricing.discountPercentage > 0 ? ' (-' + $json.pricing.discountPercentage + '%)' : '' }}</td></tr>\n</table>\n</div>\n\n{{ $json.hasNotSure ? '<div style=\"background: #FEF3C7; padding: 16px 20px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #F59E0B;\"><h3 style=\"color: #92400E; margin: 0 0 8px 0; font-size: 16px;\">ðŸ’¬ Ã€ discuter avec le prospect</h3><p style=\"color: #78350F; margin: 0; font-size: 14px;\">' + $json.notSureList + '</p></div>' : '' }}\n\n<div style=\"margin-bottom: 10px;\">\n<h3 style=\"color: #1F2937; margin: 0 0 16px 0; font-size: 18px; font-weight: 700;\">ðŸ“‹ DÃ©tail par dÃ©partement</h3>\n{{ $json.departmentsHtml }}\n</div>\n\n{{ $json.totalsHtml }}\n\n<div style=\"text-align: center; padding-top: 24px; margin-top: 24px; border-top: 1px solid #E5E7EB;\">\n<a href=\"mailto:{{ $json.contact.email }}?subject=Re: Votre devis MyDigipal - {{ $json.contact.company }}\" style=\"display: inline-block; background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); color: white; padding: 14px 35px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 15px;\">ðŸ“§ RÃ©pondre au prospect</a>\n</div>\n\n</div>\n</div>",
        "options": {}
      },
      "id": "b256f8d1-a2f0-4333-8d0b-ec7d1edb3152",
      "name": "Email to Paul",
      "type": "n8n-nodes-base.gmail",
      "position": [760, 400],
      "typeVersion": 2.1,
      "credentials": {
        "gmailOAuth2": {
          "id": "GcKRQn96MQn4VdEL",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Create binary attachment from HTML\nconst data = $input.first().json;\nconst htmlContent = data.printableHtml || '<html><body>Quote unavailable</body></html>';\nconst companyName = (data.contact?.company || 'Client').replace(/[^a-zA-Z0-9]/g, '-');\nconst fileName = `Devis-MyDigipal-${companyName}.html`;\n\n// Return with binary data\nreturn {\n  json: data,\n  binary: {\n    data: await this.helpers.prepareBinaryData(\n      Buffer.from(htmlContent, 'utf-8'),\n      fileName,\n      'text/html'\n    )\n  }\n};"
      },
      "id": "d4e5f6a7-8901-bcde-f234-567890abcdef",
      "name": "Create Attachment",
      "type": "n8n-nodes-base.code",
      "position": [640, 600],
      "typeVersion": 2
    },
    {
      "parameters": {
        "sendTo": "={{ $json.contact.email }}",
        "subject": "={{ $json.metadata?.lang === 'en' ? 'Your Marketing Quote - ' + ($json.monthlyAfterDiscount !== '0' ? $json.monthlyAfterDiscount + 'â‚¬/month' : 'Custom Quote') + ' | MyDigipal' : 'Votre devis Marketing Digital - ' + ($json.monthlyAfterDiscount !== '0' ? $json.monthlyAfterDiscount + 'â‚¬/mois' : 'Sur devis') + ' | MyDigipal' }}",
        "message": "=<div style=\"font-family: 'Segoe UI', Arial, sans-serif; max-width: 650px; margin: 0 auto; background: #ffffff;\">\n\n<div style=\"background: linear-gradient(135deg, #1e3a5f 0%, #3b82f6 100%); padding: 40px 30px; border-radius: 16px 16px 0 0; text-align: center;\">\n<h1 style=\"color: white; margin: 0 0 8px 0; font-size: 32px; font-weight: 800;\">MyDigipal</h1>\n<p style=\"color: rgba(255,255,255,0.7); margin: 0 0 20px 0; font-size: 14px;\">Digital Marketing Agency</p>\n<h2 style=\"color: white; margin: 0; font-size: 24px; font-weight: 600;\">{{ $json.metadata?.lang === 'en' ? 'Thank you, ' + $json.contact.name + '!' : 'Merci ' + $json.contact.name + ' !' }}</h2>\n<p style=\"color: rgba(255,255,255,0.9); margin: 12px 0 0 0; font-size: 16px;\">{{ $json.metadata?.lang === 'en' ? 'Your personalized quote is ready' : 'Votre devis personnalisÃ© est prÃªt' }}</p>\n</div>\n\n<div style=\"padding: 35px 30px; border: 1px solid #E5E7EB; border-top: none;\">\n\n<div style=\"background: #F0F9FF; padding: 20px; border-radius: 12px; margin-bottom: 30px; border-left: 4px solid #3b82f6;\">\n<p style=\"color: #1e40af; line-height: 1.7; font-size: 15px; margin: 0;\">{{ $json.metadata?.lang === 'en' ? 'Thank you for using our marketing calculator! We have received your quote request for <strong>' + $json.contact.company + '</strong>. Our team will carefully review your needs and contact you within <strong>24 to 48 hours</strong> to discuss your project in detail.' : 'Merci d\\'avoir utilisÃ© notre calculateur marketing ! Nous avons bien reÃ§u votre demande de devis pour <strong>' + $json.contact.company + '</strong>. Notre Ã©quipe va analyser vos besoins et vous recontacter sous <strong>24 Ã  48h</strong> pour en discuter ensemble.' }}</p>\n</div>\n\n<div style=\"background: #ECFDF5; padding: 16px 20px; border-radius: 10px; margin-bottom: 25px; border: 1px solid #A7F3D0;\">\n<p style=\"color: #065F46; margin: 0 0 8px 0; font-size: 14px;\">ðŸ“Ž {{ $json.metadata?.lang === 'en' ? '<strong>Your quote is attached</strong> to this email as an HTML document that you can save or print.' : '<strong>Votre devis est en piÃ¨ce jointe</strong> de cet email au format HTML que vous pouvez sauvegarder ou imprimer.' }}</p>\n<p style=\"color: #047857; margin: 0; font-size: 13px; font-style: italic;\">{{ $json.metadata?.lang === 'en' ? 'ðŸ’¡ Tip: Open the attachment in your browser (Chrome, Firefox, Safari) to view it properly.' : 'ðŸ’¡ Astuce : Ouvrez la piÃ¨ce jointe dans votre navigateur (Chrome, Firefox, Safari) pour l\\'afficher correctement.' }}</p>\n</div>\n\n<div style=\"margin-bottom: 25px;\">\n<h2 style=\"margin: 0 0 20px 0; color: #1F2937; font-size: 18px; display: flex; align-items: center; gap: 10px;\">\n<span style=\"font-size: 20px;\">ðŸ“‹</span>\n{{ $json.metadata?.lang === 'en' ? 'Your Services Breakdown' : 'DÃ©tail de vos services' }}\n</h2>\n{{ $json.departmentsHtml }}\n</div>\n\n{{ $json.totalsHtml }}\n\n<div style=\"background: #F0FDF4; padding: 20px; border-radius: 12px; margin: 25px 0; border: 1px solid #BBF7D0;\">\n<h3 style=\"color: #166534; margin: 0 0 12px 0; font-size: 15px; font-weight: 600;\">{{ $json.metadata?.lang === 'en' ? 'âœ¨ Included in all our services' : 'âœ¨ Inclus dans tous nos services' }}</h3>\n<ul style=\"color: #15803D; margin: 0; padding-left: 18px; line-height: 1.9; font-size: 14px;\">\n<li>{{ $json.metadata?.lang === 'en' ? 'LLM optimization (ChatGPT, Perplexity, Copilot)' : 'Optimisation pour les LLMs (ChatGPT, Perplexity, Copilot)' }}</li>\n<li>{{ $json.metadata?.lang === 'en' ? 'Premium tools (Ahrefs, SEMrush, Meta Business Suite)' : 'Outils premium (Ahrefs, SEMrush, Meta Business Suite)' }}</li>\n<li>{{ $json.metadata?.lang === 'en' ? 'Detailed monthly reporting' : 'Reporting mensuel dÃ©taillÃ©' }}</li>\n<li>{{ $json.metadata?.lang === 'en' ? 'Responsive support via email and video call' : 'Support rÃ©actif par email et visio' }}</li>\n</ul>\n</div>\n\n<div style=\"background: #FEF3C7; padding: 18px 20px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #F59E0B;\">\n<p style=\"color: #92400E; margin: 0; font-size: 14px;\">{{ $json.metadata?.lang === 'en' ? 'ðŸ’¬ <strong>Questions?</strong> Simply reply to this email - we\\'re here to help!' : 'ðŸ’¬ <strong>Des questions ?</strong> RÃ©pondez simplement Ã  cet email - nous sommes lÃ  pour vous aider !' }}</p>\n</div>\n\n<div style=\"margin-top: 30px; padding-top: 25px; border-top: 1px solid #E5E7EB;\">\n<p style=\"color: #374151; margin: 0; font-size: 15px;\">{{ $json.metadata?.lang === 'en' ? 'Looking forward to speaking with you,' : 'Ã€ trÃ¨s vite,' }}</p>\n<p style=\"margin: 12px 0 0 0;\"><strong style=\"color: #1F2937; font-size: 16px;\">Paul ANDRE</strong></p>\n<p style=\"color: #6B7280; margin: 2px 0; font-size: 14px;\">Founder - MyDigipal</p>\n<p style=\"margin: 10px 0 0 0;\"><a href=\"mailto:paul@mydigipal.com\" style=\"color: #3b82f6; text-decoration: none; font-size: 14px;\">paul@mydigipal.com</a></p>\n</div>\n\n</div>\n\n<div style=\"background: #F9FAFB; padding: 20px 30px; border-radius: 0 0 16px 16px; border: 1px solid #E5E7EB; border-top: none; text-align: center;\">\n<p style=\"color: #9CA3AF; margin: 0; font-size: 12px;\">Â© 2025 MyDigipal - Digital Marketing Agency</p>\n<p style=\"margin: 8px 0 0 0;\"><a href=\"https://www.mydigipal.com\" style=\"color: #6B7280; text-decoration: none; font-size: 12px;\">www.mydigipal.com</a></p>\n</div>\n\n</div>",
        "options": {
          "replyTo": "paul@mydigipal.com",
          "attachmentsUi": {
            "attachmentsBinary": [
              {
                "property": "data"
              }
            ]
          }
        }
      },
      "id": "677e4e03-e4b6-428b-8904-a3dfd313111b",
      "name": "Email to Prospect",
      "type": "n8n-nodes-base.gmail",
      "position": [880, 600],
      "typeVersion": 2.1,
      "credentials": {
        "gmailOAuth2": {
          "id": "GcKRQn96MQn4VdEL",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "mode": "list",
          "value": "1K4kbK_Y2JIZ-wvhRTVF2iyaFoDnjEbitXdyS7z3NyQA"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": "Calculateur financement"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Timestamp": "={{ $json.sheetTimestamp }}",
            "Nom": "={{ $json.contact.name }}",
            "Email": "={{ $json.contact.email }}",
            "Entreprise": "={{ $json.contact.company }}",
            "Langue": "={{ $json.metadata?.lang || 'fr' }}",
            "DurÃ©e (mois)": "={{ $json.duration }}",
            "Remise (%)": "={{ $json.pricing?.discountPercentage || 0 }}",
            "Domaines": "={{ $json.sheetDomains }}",
            "Mensuel Total": "={{ $json.pricing?.monthlyTotal || 0 }}",
            "Mensuel aprÃ¨s remise": "={{ $json.pricing?.monthlyAfterDiscount || 0 }}",
            "Frais gestion": "={{ $json.pricing?.managementFeesTotal || 0 }}",
            "One-off Total": "={{ $json.pricing?.oneOffTotal || 0 }}",
            "Budget mÃ©dia": "={{ $json.pricing?.adBudgetTotal || 0 }}",
            "Grand Total": "={{ $json.pricing?.grandTotalWithoutBudget || 0 }}",
            "Ã€ discuter": "={{ $json.sheetNotSure }}",
            "Devis sur mesure": "={{ $json.pricing?.hasCustomQuote ? 'Oui' : 'Non' }}",
            "Breakdown JSON": "={{ $json.sheetBreakdownJson }}"
          },
          "matchingColumns": [],
          "schema": [
            {"id": "Timestamp", "displayName": "Timestamp", "required": false, "defaultMatch": false, "canBeUsedToMatch": true, "display": true, "type": "string"},
            {"id": "Nom", "displayName": "Nom", "required": false, "defaultMatch": false, "canBeUsedToMatch": true, "display": true, "type": "string"},
            {"id": "Email", "displayName": "Email", "required": false, "defaultMatch": false, "canBeUsedToMatch": true, "display": true, "type": "string"},
            {"id": "Entreprise", "displayName": "Entreprise", "required": false, "defaultMatch": false, "canBeUsedToMatch": true, "display": true, "type": "string"},
            {"id": "Langue", "displayName": "Langue", "required": false, "defaultMatch": false, "canBeUsedToMatch": true, "display": true, "type": "string"},
            {"id": "DurÃ©e (mois)", "displayName": "DurÃ©e (mois)", "required": false, "defaultMatch": false, "canBeUsedToMatch": true, "display": true, "type": "number"},
            {"id": "Remise (%)", "displayName": "Remise (%)", "required": false, "defaultMatch": false, "canBeUsedToMatch": true, "display": true, "type": "number"},
            {"id": "Domaines", "displayName": "Domaines", "required": false, "defaultMatch": false, "canBeUsedToMatch": true, "display": true, "type": "string"},
            {"id": "Mensuel Total", "displayName": "Mensuel Total", "required": false, "defaultMatch": false, "canBeUsedToMatch": true, "display": true, "type": "number"},
            {"id": "Mensuel aprÃ¨s remise", "displayName": "Mensuel aprÃ¨s remise", "required": false, "defaultMatch": false, "canBeUsedToMatch": true, "display": true, "type": "number"},
            {"id": "Frais gestion", "displayName": "Frais gestion", "required": false, "defaultMatch": false, "canBeUsedToMatch": true, "display": true, "type": "number"},
            {"id": "One-off Total", "displayName": "One-off Total", "required": false, "defaultMatch": false, "canBeUsedToMatch": true, "display": true, "type": "number"},
            {"id": "Budget mÃ©dia", "displayName": "Budget mÃ©dia", "required": false, "defaultMatch": false, "canBeUsedToMatch": true, "display": true, "type": "number"},
            {"id": "Grand Total", "displayName": "Grand Total", "required": false, "defaultMatch": false, "canBeUsedToMatch": true, "display": true, "type": "number"},
            {"id": "Ã€ discuter", "displayName": "Ã€ discuter", "required": false, "defaultMatch": false, "canBeUsedToMatch": true, "display": true, "type": "string"},
            {"id": "Devis sur mesure", "displayName": "Devis sur mesure", "required": false, "defaultMatch": false, "canBeUsedToMatch": true, "display": true, "type": "string"},
            {"id": "Breakdown JSON", "displayName": "Breakdown JSON", "required": false, "defaultMatch": false, "canBeUsedToMatch": true, "display": true, "type": "string"}
          ]
        },
        "options": {}
      },
      "id": "c3d4e5f6-7890-abcd-ef12-34567890abcd",
      "name": "Google Sheets",
      "type": "n8n-nodes-base.googleSheets",
      "position": [760, 800],
      "typeVersion": 4.4,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YOUR_GOOGLE_SHEETS_CREDENTIAL_ID",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "62a7be75-1e4a-42af-b18e-f105aa434745",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [1000, 500],
      "typeVersion": 1
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Generate Email HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Email HTML": {
      "main": [
        [
          {
            "node": "Email to Paul",
            "type": "main",
            "index": 0
          },
          {
            "node": "Create Attachment",
            "type": "main",
            "index": 0
          },
          {
            "node": "Google Sheets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Attachment": {
      "main": [
        [
          {
            "node": "Email to Prospect",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Email to Paul": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "27e5ae242e5e368272e0dce999a9b80d042f58fe5b66d36f2c66f7002433a89c"
  }
}
