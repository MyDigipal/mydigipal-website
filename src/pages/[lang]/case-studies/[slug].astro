---
import PageLayout from '@/layouts/PageLayout.astro';
import { type Language, languages } from '@/i18n/config';
import { getCollection } from 'astro:content';
import Icon from '@/components/ui/Icon.astro';
import CaseStudySchema from '@/components/seo/CaseStudySchema.astro';
import BreadcrumbSchema from '@/components/seo/BreadcrumbSchema.astro';

export async function getStaticPaths() {
  const caseStudies = await getCollection('case-studies');
  const paths: { params: { lang: string; slug: string }; props: { caseStudy: any } }[] = [];

  // Group case studies by slug (without language prefix)
  const studiesBySlug = new Map<string, Map<string, any>>();

  caseStudies.forEach((study) => {
    const [studyLang, ...slugParts] = study.slug.split('/');
    const slug = slugParts.join('/');

    if (!studiesBySlug.has(slug)) {
      studiesBySlug.set(slug, new Map());
    }
    studiesBySlug.get(slug)!.set(studyLang, study);
  });

  // Create paths for each language that has a file
  studiesBySlug.forEach((studiesByLang, slug) => {
    Object.keys(languages).forEach((lang) => {
      const study = studiesByLang.get(lang);
      if (study) {
        paths.push({
          params: { lang, slug },
          props: { caseStudy: study },
        });
      }
    });
  });

  return paths;
}

const { lang } = Astro.params as { lang: Language };
const { caseStudy } = Astro.props;
const { Content } = await caseStudy.render();

// Get related case studies (same category, same language, exclude current)
const allCaseStudies = await getCollection('case-studies');
const relatedStudies = allCaseStudies
  .filter((s) => {
    const studyLang = s.slug.split('/')[0];
    return studyLang === lang && s.data.category === caseStudy.data.category && s.slug !== caseStudy.slug;
  })
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .slice(0, 3);

const translations = {
  en: {
    backToStudies: 'Back to Case Studies',
    challenge: 'The Challenge',
    solution: 'Our Solution',
    results: 'Key Results',
    services: 'Services Used',
    relatedStudies: 'Related Case Studies',
    viewStudy: 'View Case Study',
    share: 'Share this case study',
    ctaTitle: 'Ready to achieve similar results?',
    ctaText: 'Let\'s discuss how we can help you reach your business goals.',
    ctaButton: 'Start Your Project',
  },
  fr: {
    backToStudies: 'Retour aux Études de Cas',
    challenge: 'Le Défi',
    solution: 'Notre Solution',
    results: 'Résultats Clés',
    services: 'Services Utilisés',
    relatedStudies: 'Études de Cas Similaires',
    viewStudy: 'Voir l\'étude',
    share: 'Partager cette étude',
    ctaTitle: 'Prêt à obtenir des résultats similaires ?',
    ctaText: 'Discutons de comment nous pouvons vous aider à atteindre vos objectifs.',
    ctaButton: 'Démarrer Votre Projet',
  },
};

const t = translations[lang] || translations.en;

// SEO Schema data
const studySlug = caseStudy.slug.replace(/^(en|fr)\//, '');
const studyUrl = `https://mydigipal.com/${lang}/case-studies/${studySlug}`;
const breadcrumbItems = [
  { name: lang === 'fr' ? 'Accueil' : 'Home', url: `/${lang}` },
  { name: lang === 'fr' ? 'Études de Cas' : 'Case Studies', url: `/${lang}/case-studies` },
  { name: caseStudy.data.client, url: `/${lang}/case-studies/${studySlug}` }
];
---

<PageLayout
  lang={lang}
  title={`${caseStudy.data.client} - ${caseStudy.data.title}`}
  description={caseStudy.data.description}
>
  <!-- Structured Data -->
  <CaseStudySchema
    client={caseStudy.data.client}
    title={caseStudy.data.title}
    description={caseStudy.data.description}
    url={studyUrl}
    image={caseStudy.data.image}
    datePublished={caseStudy.data.date}
    services={caseStudy.data.services}
    lang={lang}
    testimonial={caseStudy.data.testimonial}
  />
  <BreadcrumbSchema items={breadcrumbItems} />

  <!-- Hero Section -->
  <section class="relative bg-slate-950 text-white pt-32 pb-40 overflow-hidden">
    <!-- Background Image with Overlay -->
    <div class="absolute inset-0">
      <img
        src={caseStudy.data.image}
        alt={caseStudy.data.client}
        class="w-full h-full object-cover opacity-20"
      />
      <div class="absolute inset-0 bg-gradient-to-b from-slate-950/80 via-slate-950/90 to-slate-950"></div>
    </div>

    <!-- Background Effects -->
    <div class="absolute inset-0 pointer-events-none">
      <div class="absolute top-20 -left-20 w-96 h-96 bg-blue-500/10 rounded-full blur-[120px]"></div>
      <div class="absolute bottom-20 -right-20 w-96 h-96 bg-indigo-500/10 rounded-full blur-[120px]"></div>
    </div>

    <div class="container-custom relative z-10">
      <!-- Back Link -->
      <a
        href={`/${lang}/case-studies`}
        class="inline-flex items-center gap-2 text-slate-400 hover:text-white transition-colors mb-8"
      >
        <Icon name="arrow-left" size={16} />
        {t.backToStudies}
      </a>

      <div class="flex flex-col lg:flex-row gap-8 items-start">
        <!-- Left Content -->
        <div class="flex-1">
          <!-- Logo & Category -->
          <div class="flex items-center gap-4 mb-6">
            {caseStudy.data.logo && (
              <div class="p-3 bg-white rounded-xl shadow-lg">
                <img src={caseStudy.data.logo} alt={caseStudy.data.client} class="h-10 w-auto object-contain" />
              </div>
            )}
            <span class={`px-4 py-1.5 rounded-full text-sm font-bold ${caseStudy.data.category === 'automotive' ? 'bg-amber-500/20 text-amber-300 border border-amber-500/30' : 'bg-blue-500/20 text-blue-300 border border-blue-500/30'}`}>
              {caseStudy.data.category === 'automotive' ? (lang === 'fr' ? 'Automobile' : 'Automotive') : 'B2B Tech'}
            </span>
          </div>

          <!-- Client Name -->
          <h2 class="text-2xl text-blue-400 font-semibold mb-2">{caseStudy.data.client}</h2>

          <!-- Title -->
          <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold mb-6 leading-tight">
            {caseStudy.data.title}
          </h1>

          <!-- Description -->
          <p class="text-xl text-slate-300 max-w-2xl">
            {caseStudy.data.description}
          </p>

          <!-- Services Tags -->
          <div class="flex flex-wrap gap-2 mt-8">
            {caseStudy.data.services.map((service: string) => (
              <span class="px-4 py-2 bg-slate-800/50 border border-slate-700 text-slate-300 rounded-lg text-sm font-medium">
                {service}
              </span>
            ))}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- KPIs Section - Floating Cards -->
  <section class="relative -mt-24 pb-16 z-20">
    <div class="container-custom">
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
        {caseStudy.data.kpis.map((kpi: { value: string; label: string; icon?: string }, index: number) => (
          <div class="kpi-card group bg-white rounded-2xl p-6 shadow-xl hover:shadow-2xl transition-all duration-500 border border-slate-100 hover:border-blue-200 hover:-translate-y-1">
            <div class="flex items-center gap-3 mb-3">
              <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white">
                <Icon name={kpi.icon || 'trending-up'} size={20} />
              </div>
            </div>
            <div
              class="kpi-value text-3xl lg:text-4xl font-bold text-slate-900 mb-1"
              data-value={kpi.value}
            >
              {kpi.value}
            </div>
            <div class="text-sm text-slate-500 font-medium">{kpi.label}</div>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Challenge & Solution -->
  <section class="py-16 bg-white">
    <div class="container-custom">
      <div class="grid lg:grid-cols-2 gap-12">
        <!-- Challenge -->
        <div class="group">
          <div class="flex items-center gap-3 mb-6">
            <div class="w-12 h-12 rounded-xl bg-red-100 text-red-600 flex items-center justify-center">
              <Icon name="target" size={24} />
            </div>
            <h2 class="text-2xl font-bold text-slate-900">{t.challenge}</h2>
          </div>
          <div class="p-6 bg-slate-50 rounded-2xl border border-slate-100">
            <p class="text-lg text-slate-600 leading-relaxed">
              {caseStudy.data.challenge}
            </p>
          </div>
        </div>

        <!-- Solution -->
        <div class="group">
          <div class="flex items-center gap-3 mb-6">
            <div class="w-12 h-12 rounded-xl bg-green-100 text-green-600 flex items-center justify-center">
              <Icon name="check-circle" size={24} />
            </div>
            <h2 class="text-2xl font-bold text-slate-900">{t.solution}</h2>
          </div>
          <div class="p-6 bg-slate-50 rounded-2xl border border-slate-100">
            <p class="text-lg text-slate-600 leading-relaxed">
              {caseStudy.data.solution}
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Testimonial -->
  {caseStudy.data.testimonial && (
    <section class="py-16 bg-gradient-to-br from-blue-600 via-blue-700 to-indigo-800 text-white relative overflow-hidden">
      <!-- Background Pattern -->
      <div class="absolute inset-0 opacity-10">
        <div class="absolute top-10 left-10 w-64 h-64 border border-white rounded-full"></div>
        <div class="absolute bottom-10 right-10 w-96 h-96 border border-white rounded-full"></div>
      </div>

      <div class="container-custom relative z-10">
        <div class="max-w-4xl mx-auto text-center">
          <Icon name="quote" size={48} class="text-blue-300 mx-auto mb-6 opacity-50" />
          <blockquote class="text-2xl md:text-3xl font-medium mb-8 leading-relaxed">
            "{caseStudy.data.testimonial.quote}"
          </blockquote>
          <div class="flex items-center justify-center gap-4">
            {caseStudy.data.testimonial.image ? (
              <img
                src={caseStudy.data.testimonial.image}
                alt={caseStudy.data.testimonial.author}
                class="w-14 h-14 rounded-full object-cover border-2 border-white/30"
              />
            ) : (
              <div class="w-14 h-14 rounded-full bg-white/20 flex items-center justify-center text-xl font-bold">
                {caseStudy.data.testimonial.author.charAt(0)}
              </div>
            )}
            <div class="text-left">
              <div class="font-semibold text-lg">{caseStudy.data.testimonial.author}</div>
              <div class="text-blue-200">{caseStudy.data.testimonial.role}</div>
            </div>
          </div>
        </div>
      </div>
    </section>
  )}

  <!-- Full Content -->
  <section class="py-16 bg-white">
    <div class="container-custom max-w-4xl mx-auto">
      <article class="prose prose-lg prose-slate max-w-none">
        <Content />
      </article>

      <!-- Share -->
      <div class="mt-12 pt-8 border-t border-slate-200">
        <h3 class="text-lg font-bold text-slate-900 mb-4">{t.share}</h3>
        <div class="flex gap-3">
          <a
            href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(caseStudy.data.client + ': ' + caseStudy.data.title)}&url=${encodeURIComponent(Astro.url.href)}`}
            target="_blank"
            rel="noopener noreferrer"
            class="w-10 h-10 rounded-full bg-slate-100 hover:bg-blue-500 hover:text-white text-slate-600 flex items-center justify-center transition-colors"
          >
            <Icon name="twitter" size={18} />
          </a>
          <a
            href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(Astro.url.href)}`}
            target="_blank"
            rel="noopener noreferrer"
            class="w-10 h-10 rounded-full bg-slate-100 hover:bg-blue-700 hover:text-white text-slate-600 flex items-center justify-center transition-colors"
          >
            <Icon name="linkedin" size={18} />
          </a>
          <button
            onclick={`navigator.clipboard.writeText('${Astro.url.href}')`}
            class="w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-600 flex items-center justify-center transition-colors"
            title="Copy link"
          >
            <Icon name="link" size={18} />
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Related Case Studies -->
  {relatedStudies.length > 0 && (
    <section class="py-16 bg-slate-50">
      <div class="container-custom">
        <h2 class="text-2xl font-bold text-slate-900 mb-8">{t.relatedStudies}</h2>
        <div class="grid md:grid-cols-3 gap-8">
          {relatedStudies.map((study) => (
            <article class="group bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-xl transition-all duration-300 border border-slate-100">
              <a href={`/${lang}/case-studies/${study.slug.replace(/^(en|fr)\//, '')}`} class="block relative aspect-[16/10] overflow-hidden">
                <img
                  src={study.data.image}
                  alt={study.data.client}
                  class="absolute inset-0 w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                  loading="lazy"
                />
                <div class="absolute inset-0 bg-gradient-to-t from-slate-900/60 to-transparent"></div>
                <div class="absolute bottom-4 left-4 right-4">
                  <h3 class="text-lg font-bold text-white">{study.data.client}</h3>
                </div>
              </a>
              <div class="p-6">
                <p class="text-slate-600 text-sm mb-4 line-clamp-2">{study.data.title}</p>
                <a
                  href={`/${lang}/case-studies/${study.slug.replace(/^(en|fr)\//, '')}`}
                  class="inline-flex items-center gap-2 text-blue-600 font-medium text-sm hover:text-blue-700 transition-colors"
                >
                  {t.viewStudy}
                  <Icon name="arrow-right" size={14} />
                </a>
              </div>
            </article>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- CTA -->
  <section class="py-20 bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900 text-white">
    <div class="container-custom text-center">
      <h2 class="text-3xl md:text-4xl font-bold mb-4">{t.ctaTitle}</h2>
      <p class="text-xl text-slate-300 mb-8 max-w-2xl mx-auto">{t.ctaText}</p>
      <a
        href={`/${lang}/contact`}
        class="inline-flex items-center gap-3 px-8 py-4 rounded-xl bg-white text-blue-700 font-semibold text-lg shadow-xl hover:shadow-2xl hover:scale-105 transition-all duration-300"
      >
        {t.ctaButton}
        <Icon name="arrow-right" size={20} />
      </a>
    </div>
  </section>
</PageLayout>

<script>
  // Animate KPI values on scroll
  const observerOptions = {
    root: null,
    rootMargin: '0px',
    threshold: 0.5,
  };

  const animateValue = (element: HTMLElement, start: number, end: number, duration: number, prefix: string, suffix: string) => {
    let startTimestamp: number | null = null;
    const step = (timestamp: number) => {
      if (!startTimestamp) startTimestamp = timestamp;
      const progress = Math.min((timestamp - startTimestamp) / duration, 1);
      const easeOutQuart = 1 - Math.pow(1 - progress, 4);
      const current = Math.floor(start + (end - start) * easeOutQuart);
      element.textContent = prefix + current + suffix;
      if (progress < 1) {
        window.requestAnimationFrame(step);
      } else {
        element.textContent = prefix + end + suffix;
      }
    };
    window.requestAnimationFrame(step);
  };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        const kpiCards = document.querySelectorAll('.kpi-card');
        kpiCards.forEach((card, index) => {
          setTimeout(() => {
            card.classList.add('animate-in');
            const valueEl = card.querySelector('.kpi-value') as HTMLElement;
            if (valueEl) {
              const value = valueEl.getAttribute('data-value') || '';
              const numericMatch = value.match(/(-?\d+\.?\d*)/);
              if (numericMatch) {
                const numericValue = parseFloat(numericMatch[1]);
                const prefix = value.substring(0, value.indexOf(numericMatch[1]));
                const suffix = value.substring(value.indexOf(numericMatch[1]) + numericMatch[1].length);
                valueEl.textContent = prefix + '0' + suffix;
                animateValue(valueEl, 0, numericValue, 1500, prefix, suffix);
              }
            }
          }, index * 100);
        });
        observer.disconnect();
      }
    });
  }, observerOptions);

  const kpiSection = document.querySelector('.kpi-card');
  if (kpiSection) {
    observer.observe(kpiSection);
  }
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .kpi-card {
    opacity: 0;
    transform: translateY(20px);
  }

  .kpi-card.animate-in {
    animation: slideUp 0.6s ease-out forwards;
  }

  @keyframes slideUp {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Prose styles */
  .prose h2 {
    @apply text-2xl font-bold text-slate-900 mt-10 mb-4;
  }

  .prose h3 {
    @apply text-xl font-bold text-slate-900 mt-8 mb-3;
  }

  .prose p {
    @apply text-slate-600 leading-relaxed mb-4;
  }

  .prose ul, .prose ol {
    @apply my-4 pl-6;
  }

  .prose li {
    @apply text-slate-600 mb-2;
  }

  .prose a {
    @apply text-blue-600 hover:text-blue-700 underline;
  }

  .prose strong {
    @apply text-slate-900 font-semibold;
  }

  .prose blockquote {
    @apply border-l-4 border-blue-500 pl-6 italic text-slate-600 my-6;
  }
</style>
