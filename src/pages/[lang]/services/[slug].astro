---
import PageLayout from '@/layouts/PageLayout.astro';
import { type Language, languages } from '@/i18n/config';
import { t } from '@/i18n/utils';
import { getCollection } from 'astro:content';

// Components
import Badge from '@/components/ui/Badge.astro';
import Button from '@/components/ui/Button.astro';
import Icon from '@/components/ui/Icon.astro';

// Sections
import HeroService from '@/components/sections/HeroService.astro';
import MetricsCounter from '@/components/sections/MetricsCounter.astro';
import FeaturesShowcase from '@/components/sections/FeaturesShowcase.astro';
import ProcessTimeline from '@/components/sections/ProcessTimeline.astro';
import TestimonialSpotlight from '@/components/sections/TestimonialSpotlight.astro';
import CalculatorPreview from '@/components/sections/CalculatorPreview.astro';
import ServiceCTA from '@/components/sections/ServiceCTA.astro';

export async function getStaticPaths() {
  const paths = [];

  for (const lang of Object.keys(languages)) {
    try {
      const services = await getCollection('services', ({ id }) => {
        return id.startsWith(`${lang}/`);
      });

      for (const service of services) {
        const slug = service.id.replace(`${lang}/`, '').replace('.mdx', '');
        paths.push({
          params: { lang, slug },
          props: { service },
        });
      }
    } catch (e) {
      // Collection might be empty
    }
  }

  return paths;
}

const { lang } = Astro.params as { lang: Language };
const { service } = Astro.props;
const { Content } = await service.render();

const {
  title,
  description,
  color = 'primary',
  hero,
  metrics,
  features,
  process,
  testimonial,
  calculatorServiceId,
  seo
} = service.data;
---

<PageLayout
  lang={lang}
  title={seo?.title || title}
  description={seo?.description || description}
>
  <!-- Hero Section - Immersive -->
  <HeroService
    lang={lang}
    badge={hero?.badge}
    headline={hero?.headline || title}
    subheadline={hero?.subheadline}
    description={description}
    color={color}
  />

  <!-- Metrics Counter -->
  {metrics && metrics.length > 0 && (
    <MetricsCounter metrics={metrics} color={color} />
  )}

  <!-- Features Showcase - Varied Styles -->
  {features && features.length > 0 && (
    <FeaturesShowcase
      lang={lang}
      features={features}
      color={color}
    />
  )}

  <!-- Process Timeline - Interactive -->
  {process && process.length > 0 && (
    <ProcessTimeline
      lang={lang}
      steps={process}
      color={color}
    />
  )}

  <!-- Content from MDX -->
  <section class="py-20 bg-white">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="prose-custom animate-on-scroll">
        <Content />
      </div>
    </div>
  </section>

  <!-- Testimonial Spotlight -->
  {testimonial && (
    <TestimonialSpotlight
      quote={testimonial.quote}
      author={testimonial.author}
      role={testimonial.role}
      company={testimonial.company}
      image={testimonial.image}
    />
  )}

  <!-- Calculator Preview -->
  {calculatorServiceId && (
    <CalculatorPreview
      lang={lang}
      serviceId={calculatorServiceId}
      serviceName={title}
      color={color}
    />
  )}

  <!-- Final CTA -->
  <ServiceCTA lang={lang} />
</PageLayout>

<style>
  /* Page-specific animations */
  @keyframes float {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    50% { transform: translateY(-20px) rotate(5deg); }
  }

  @keyframes pulse-glow {
    0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
    50% { box-shadow: 0 0 40px rgba(59, 130, 246, 0.6); }
  }
</style>
