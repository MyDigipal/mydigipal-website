---
import PageLayout from '@/layouts/PageLayout.astro';
import Icon from '@/components/ui/Icon.astro';
import AntiSpam from '@/components/ui/AntiSpam.astro';
import { languages, type Language } from '@/i18n/config';

export function getStaticPaths() {
  return Object.keys(languages).map((lang) => ({
    params: { lang },
  }));
}

const { lang } = Astro.params as { lang: Language };

// Translations
const t = {
  en: {
    hero: {
      badge: "Let's Talk",
      title: "Start Your Digital",
      titleHighlight: "Transformation",
      subtitle: "Get a free audit of your digital presence and discover how we can accelerate your growth.",
    },
    form: {
      name: "Full Name",
      namePlaceholder: "John Doe",
      email: "Email Address",
      emailPlaceholder: "john@company.com",
      company: "Company",
      companyPlaceholder: "Your Company",
      service: "Services Interested In",
      serviceOptions: ["SEO", "Google Ads", "Paid Social", "ABM", "Content Creation", "Marketing Automation", "Full Strategy", "Other"],
      message: "Tell us about your project",
      messagePlaceholder: "What are your goals? What challenges are you facing?",
      submit: "Send Message",
      sending: "Sending...",
      success: "Message sent! We'll get back to you within 24 hours.",
      error: "Something went wrong. Please try again or email us directly.",
    },
    contact: {
      title: "Get in Touch",
      subtitle: "YOUR SUCCESS, OUR MISSION",
      email: "paul@mydigipal.com",
      response: "We respond within 24 hours",
      locations: "London • Paris • Remote",
    },
    values: {
      badge: "OUR VALUES",
      title: "The values that drive everything we do",
      items: [
        {
          icon: "globe",
          title: "International",
          description: "Our Marketeers are from all around the globe. We are building a digital intelligence using a collaboration of talented minds with all its specialties and affinities.",
        },
        {
          icon: "users",
          title: "More than a Pair of Hands",
          description: "We don't like to just execute. Count on us to bring initiatives and strategy. Most clients start small, to end up never leaving.",
        },
        {
          icon: "check-circle",
          title: "Less Fluff",
          description: "We want to be able to pull orange flags when needed, as much as celebrating victories. Regardless, you're in the loop with weekly calls.",
        },
        {
          icon: "award",
          title: "Quality and Expertise",
          description: "Our account managers are true marketeers in their own specialty (Creative / Content / Paid ads / Marketing Ops).",
        },
        {
          icon: "zap",
          title: "Short SLA's",
          description: "No ticket system, deserted email box. We're working 7/7 around the clock to get things done fast and with quality.",
        },
        {
          icon: "heart",
          title: "Fair Offering",
          description: "Let us start with a short term dedicated project, you can extend the scope of work anytime to add on more services which we'll quote within 24h.",
        },
      ],
    },
    team: {
      badge: "MYDIGIPAL TEAM",
      title: "The amazing people behind the scene",
    },
  },
  fr: {
    hero: {
      badge: "Parlons-en",
      title: "Commencez Votre",
      titleHighlight: "Transformation Digitale",
      subtitle: "Obtenez un audit gratuit de votre présence digitale et découvrez comment nous pouvons accélérer votre croissance.",
    },
    form: {
      name: "Nom Complet",
      namePlaceholder: "Jean Dupont",
      email: "Adresse Email",
      emailPlaceholder: "jean@entreprise.com",
      company: "Entreprise",
      companyPlaceholder: "Votre Entreprise",
      service: "Services Souhaités",
      serviceOptions: ["SEO", "Google Ads", "Paid Social", "ABM", "Création de Contenu", "Marketing Automation", "Stratégie Complète", "Autre"],
      message: "Parlez-nous de votre projet",
      messagePlaceholder: "Quels sont vos objectifs ? Quels défis rencontrez-vous ?",
      submit: "Envoyer le Message",
      sending: "Envoi en cours...",
      success: "Message envoyé ! Nous vous répondons sous 24 heures.",
      error: "Une erreur est survenue. Réessayez ou contactez-nous directement.",
    },
    contact: {
      title: "Contactez-nous",
      subtitle: "VOTRE SUCCÈS, NOTRE MISSION",
      email: "paul@mydigipal.com",
      response: "Nous répondons sous 24 heures",
      locations: "Londres • Paris • Remote",
    },
    values: {
      badge: "NOS VALEURS",
      title: "Les valeurs qui guident tout ce que nous faisons",
      items: [
        {
          icon: "globe",
          title: "International",
          description: "Nos Marketeers viennent du monde entier. Nous construisons une intelligence digitale grâce à une collaboration de talents avec toutes leurs spécialités.",
        },
        {
          icon: "users",
          title: "Plus qu'une Paire de Mains",
          description: "Nous n'aimons pas juste exécuter. Comptez sur nous pour apporter des initiatives et de la stratégie. La plupart des clients commencent petit, pour ne plus jamais partir.",
        },
        {
          icon: "check-circle",
          title: "Moins de Blabla",
          description: "Nous voulons pouvoir lever des drapeaux orange quand nécessaire, autant que célébrer les victoires. Vous êtes dans la boucle avec des calls hebdomadaires.",
        },
        {
          icon: "award",
          title: "Qualité et Expertise",
          description: "Nos account managers sont de vrais marketeers dans leur spécialité (Creative / Content / Paid ads / Marketing Ops).",
        },
        {
          icon: "zap",
          title: "SLA Courts",
          description: "Pas de système de tickets, pas de boîte mail déserte. Nous travaillons 7/7 pour faire avancer les choses rapidement et avec qualité.",
        },
        {
          icon: "heart",
          title: "Offre Équitable",
          description: "Commençons par un projet dédié à court terme, vous pouvez étendre le scope à tout moment avec un devis sous 24h.",
        },
      ],
    },
    team: {
      badge: "ÉQUIPE MYDIGIPAL",
      title: "Les personnes incroyables derrière la scène",
    },
  },
}[lang];

const seo = {
  en: {
    title: "Contact Us - Start Your Digital Journey",
    description: "Contact MyDigipal for a free digital marketing audit. No commitment required. Our expert team responds within 24 hours to discuss your growth strategy.",
  },
  fr: {
    title: "Contactez-nous - Commencez Votre Transformation",
    description: "Contactez MyDigipal pour un audit gratuit de votre marketing digital. Sans engagement. Notre équipe d'experts répond sous 24h pour discuter de votre stratégie de croissance.",
  },
}[lang];
---

<PageLayout
  title={seo.title}
  description={seo.description}
  lang={lang}
>
  <!-- Hero Section -->
  <section class="relative py-20 lg:py-28 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 overflow-hidden">
    <!-- Background decoration -->
    <div class="absolute inset-0 overflow-hidden">
      <div class="absolute -top-40 -right-40 w-80 h-80 bg-primary-500/10 rounded-full blur-3xl"></div>
      <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-violet-500/10 rounded-full blur-3xl"></div>
    </div>

    <div class="container-custom relative z-10">
      <div class="text-center max-w-3xl mx-auto mb-16">
        <span class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-primary-500/10 border border-primary-500/20 text-primary-400 text-sm font-medium mb-6">
          <Icon name="message-circle" size={16} />
          {t.hero.badge}
        </span>
        <h1 class="text-4xl lg:text-6xl font-bold text-white mb-6">
          {t.hero.title} <span class="text-transparent bg-clip-text bg-gradient-to-r from-primary-400 to-violet-400">{t.hero.titleHighlight}</span>
        </h1>
        <p class="text-xl text-slate-300">
          {t.hero.subtitle}
        </p>
      </div>

      <!-- Contact Form + Info Grid -->
      <div class="grid lg:grid-cols-5 gap-8 max-w-6xl mx-auto">

        <!-- Form (3 columns) -->
        <div class="lg:col-span-3 bg-white rounded-2xl p-8 shadow-2xl">
          <form id="contact-form" class="space-y-6">
            <div class="grid md:grid-cols-2 gap-6">
              <!-- Name -->
              <div>
                <label for="name" class="block text-sm font-medium text-slate-700 mb-2">{t.form.name}</label>
                <input
                  type="text"
                  id="name"
                  name="name"
                  required
                  placeholder={t.form.namePlaceholder}
                  class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 transition-all outline-none"
                />
              </div>

              <!-- Email -->
              <div>
                <label for="email" class="block text-sm font-medium text-slate-700 mb-2">{t.form.email}</label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  required
                  placeholder={t.form.emailPlaceholder}
                  class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 transition-all outline-none"
                />
              </div>
            </div>

            <!-- Company -->
            <div>
              <label for="company" class="block text-sm font-medium text-slate-700 mb-2">{t.form.company}</label>
              <input
                type="text"
                id="company"
                name="company"
                placeholder={t.form.companyPlaceholder}
                class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 transition-all outline-none"
              />
            </div>

            <!-- Services (Checkboxes) -->
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-3">{t.form.service}</label>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                {t.form.serviceOptions.map((option) => (
                  <label class="flex items-center gap-2 cursor-pointer group">
                    <input
                      type="checkbox"
                      name="services"
                      value={option}
                      class="w-4 h-4 text-primary-600 border-slate-300 rounded focus:ring-primary-500 focus:ring-2"
                    />
                    <span class="text-sm text-slate-600 group-hover:text-slate-900 transition-colors">{option}</span>
                  </label>
                ))}
              </div>
            </div>

            <!-- Message -->
            <div>
              <label for="message" class="block text-sm font-medium text-slate-700 mb-2">{t.form.message}</label>
              <textarea
                id="message"
                name="message"
                rows="4"
                required
                placeholder={t.form.messagePlaceholder}
                class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 transition-all outline-none resize-none"
              ></textarea>
            </div>

            <!-- Anti-Spam Protection -->
            <AntiSpam lang={lang} formId="contact" />

            <!-- Submit Button -->
            <button
              type="submit"
              id="submit-btn"
              class="w-full py-4 px-6 bg-gradient-to-r from-primary-600 to-violet-600 hover:from-primary-500 hover:to-violet-500 text-white font-semibold rounded-lg transition-all duration-300 transform hover:scale-[1.02] hover:shadow-lg flex items-center justify-center gap-2"
            >
              <span id="btn-text">{t.form.submit}</span>
              <Icon name="send" size={20} id="btn-icon" />
              <svg id="btn-spinner" class="hidden animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </button>

            <!-- Status Messages -->
            <div id="form-success" class="hidden p-4 bg-green-50 border border-green-200 rounded-lg text-green-700 text-center">
              {t.form.success}
            </div>
            <div id="form-error" class="hidden p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-center">
              {t.form.error}
            </div>
          </form>
        </div>

        <!-- Contact Info (2 columns) -->
        <div class="lg:col-span-2 space-y-6">
          <!-- Get in Touch Card -->
          <div class="bg-gradient-to-br from-primary-600 to-violet-600 rounded-2xl p-8 text-white">
            <h2 class="text-2xl font-bold mb-2">{t.contact.title}</h2>
            <p class="text-primary-100 text-sm uppercase tracking-wider mb-8">{t.contact.subtitle}</p>

            <div class="space-y-6">
              <a href={`mailto:${t.contact.email}`} class="flex items-center gap-4 group">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center group-hover:bg-white/30 transition-colors">
                  <Icon name="mail" size={24} />
                </div>
                <div>
                  <p class="font-semibold">{t.contact.email}</p>
                  <p class="text-sm text-primary-100">{t.contact.response}</p>
                </div>
              </a>

              <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                  <Icon name="map-pin" size={24} />
                </div>
                <div>
                  <p class="font-semibold">{t.contact.locations}</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Social Links -->
          <div class="bg-slate-800 rounded-2xl p-6">
            <p class="text-slate-400 text-sm mb-4">Follow us</p>
            <div class="flex gap-4">
              <a href="https://www.linkedin.com/company/mydigipal/" target="_blank" rel="noopener" class="w-12 h-12 bg-slate-700 hover:bg-primary-600 rounded-xl flex items-center justify-center text-white transition-colors">
                <Icon name="linkedin" size={24} />
              </a>
              <a href="https://twitter.com/mydigipal" target="_blank" rel="noopener" class="w-12 h-12 bg-slate-700 hover:bg-primary-600 rounded-xl flex items-center justify-center text-white transition-colors">
                <Icon name="twitter" size={24} />
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Values Section -->
  <section class="py-20 lg:py-28 bg-slate-50">
    <div class="container-custom">
      <div class="text-center mb-16">
        <span class="inline-block px-4 py-2 rounded-full bg-primary-100 text-primary-700 text-sm font-medium mb-4">
          {t.values.badge}
        </span>
        <h2 class="text-3xl lg:text-4xl font-bold text-slate-900">
          {t.values.title}
        </h2>
      </div>

      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
        {t.values.items.map((value, index) => (
          <div class="bg-white rounded-xl p-6 shadow-sm hover:shadow-lg transition-shadow duration-300 group">
            <div class="w-12 h-12 bg-primary-100 rounded-xl flex items-center justify-center text-primary-600 mb-4 group-hover:bg-primary-600 group-hover:text-white transition-colors">
              <Icon name={value.icon} size={24} />
            </div>
            <h3 class="text-lg font-semibold text-slate-900 mb-2">{value.title}</h3>
            <p class="text-slate-600">{value.description}</p>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Team Section Placeholder -->
  <section class="py-20 lg:py-28">
    <div class="container-custom">
      <div class="text-center mb-16">
        <span class="inline-block px-4 py-2 rounded-full bg-primary-100 text-primary-700 text-sm font-medium mb-4">
          {t.team.badge}
        </span>
        <h2 class="text-3xl lg:text-4xl font-bold text-slate-900 mb-4">
          {t.team.title}
        </h2>
        <p class="text-slate-600 max-w-2xl mx-auto">
          {lang === 'en'
            ? 'A diverse team of marketing experts from around the world, united by a passion for results.'
            : 'Une équipe diverse d\'experts marketing du monde entier, unis par une passion pour les résultats.'}
        </p>
      </div>

      <!-- Team Grid -->
      <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-6">
        {[
          { name: "Paul Andre", role: "CEO & Founder", image: "/images/team/Team_Paul_Andre.webp" },
          { name: "Alizee Varloud", role: "ABM Lead", image: "/images/team/Team_Alizee_Varloud.avif" },
          { name: "Bruce Eidsvik", role: "ABM Leader", image: "/images/team/Team_Bruce_Eidsvik.avif" },
          { name: "Victoria Doherty", role: "Account Manager", image: "/images/team/Team_Victoria_Doherty.avif" },
          { name: "Callum Dunbar", role: "Digital Marketing Manager", image: "/images/team/Team_Callum_Dunbar.avif" },
          { name: "Jordan Langlois", role: "Digital Marketing Manager", image: "/images/team/Team_Jordan_Langlois.avif" },
          { name: "Alexandre Echement", role: "Digital Marketing Manager", image: "/images/team/Team_Alexandre_Echement.avif" },
          { name: "Diksha Mishra", role: "Performance Marketing Manager", image: "/images/team/Team_Diksha_Mishra.avif" },
          { name: "Amna Khan", role: "Design Lead", image: "/images/team/Team_Amna_Khan.avif" },
          { name: "Heather Mann", role: "Digital Marketing Executive", image: "/images/team/Team_Heather_Mann.avif" },
          { name: "Juliette Joire", role: "Digital Marketing Executive", image: "/images/team/Team_Juliette_Joire.avif" },
          { name: "Shuai Yang", role: "Digital Marketing Executive", image: "/images/team/Team_Shuai_Yang.avif" },
          { name: "Sophie Roe", role: "Digital Marketing Executive", image: "/images/team/Team_Sophie_Roe.avif" },
          { name: "Chirag Solanki", role: "Marketing Ops Manager", image: "/images/team/Team_Chirag_Solanki.avif" },
        ].map((member) => (
          <div class="text-center group">
            <div class="aspect-square rounded-xl mb-3 overflow-hidden">
              <img
                src={member.image}
                alt={member.name}
                class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                loading="lazy"
              />
            </div>
            <h3 class="font-semibold text-slate-900 text-sm">{member.name}</h3>
            <p class="text-slate-500 text-xs">{member.role}</p>
          </div>
        ))}
      </div>
    </div>
  </section>
</PageLayout>

<script define:vars={{ webhookUrl: 'https://n8n.mydigipal.com/webhook/mydigipal-contact', pageLang: lang }}>
  const form = document.getElementById('contact-form');
  const submitBtn = document.getElementById('submit-btn');
  const btnText = document.getElementById('btn-text');
  const btnIcon = document.getElementById('btn-icon');
  const btnSpinner = document.getElementById('btn-spinner');
  const successMsg = document.getElementById('form-success');
  const errorMsg = document.getElementById('form-error');

  // Anti-spam validation
  function validateAntiSpam(formData) {
    const messages = {
      en: {
        math: 'Incorrect answer to the security question. Please try again.',
        honeypot: 'Form submission blocked.',
        timing: 'Please take a moment to fill out the form properly.',
      },
      fr: {
        math: 'Réponse incorrecte à la question de sécurité. Veuillez réessayer.',
        honeypot: 'Soumission du formulaire bloquée.',
        timing: 'Veuillez prendre le temps de remplir le formulaire correctement.',
      },
    };
    const lang = pageLang || 'en';
    const t = messages[lang];

    // Check honeypot
    const honeypot = formData.get('website_url');
    if (honeypot && String(honeypot).trim() !== '') {
      return { valid: false, error: t.honeypot };
    }

    // Check timing (minimum 3 seconds)
    const timestamp = formData.get('antispam_timestamp');
    if (timestamp) {
      const elapsed = (Date.now() - parseInt(timestamp, 10)) / 1000;
      if (elapsed < 3) {
        return { valid: false, error: t.timing };
      }
    }

    // Check math answer
    const answer = formData.get('antispam_answer');
    const expected = formData.get('antispam_expected');
    if (!answer || !expected) {
      return { valid: false, error: t.math };
    }

    try {
      const expectedVal = parseInt(atob(expected), 10);
      const providedVal = parseInt(answer, 10);
      if (providedVal !== expectedVal) {
        return { valid: false, error: t.math };
      }
    } catch (e) {
      return { valid: false, error: t.math };
    }

    return { valid: true };
  }

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);

    // Validate anti-spam first
    const spamCheck = validateAntiSpam(formData);
    if (!spamCheck.valid) {
      const errorEl = document.getElementById('antispam-error-contact');
      if (errorEl) {
        errorEl.textContent = spamCheck.error;
        errorEl.classList.remove('hidden');
      }
      const inputEl = document.getElementById('antispam-contact');
      if (inputEl) {
        inputEl.classList.add('border-red-500');
        inputEl.focus();
      }
      return;
    }

    // Clear anti-spam error if valid
    const errorEl = document.getElementById('antispam-error-contact');
    if (errorEl) errorEl.classList.add('hidden');
    const inputEl = document.getElementById('antispam-contact');
    if (inputEl) inputEl.classList.remove('border-red-500');

    // Show loading state
    btnText.textContent = pageLang === 'fr' ? 'Envoi en cours...' : 'Sending...';
    btnIcon?.classList.add('hidden');
    btnSpinner?.classList.remove('hidden');
    submitBtn.disabled = true;
    successMsg?.classList.add('hidden');
    errorMsg?.classList.add('hidden');

    // Collect all checked services
    const services = [];
    form.querySelectorAll('input[name="services"]:checked').forEach((checkbox) => {
      services.push(checkbox.value);
    });

    const data = {
      name: formData.get('name'),
      email: formData.get('email'),
      company: formData.get('company'),
      services: services,
      message: formData.get('message'),
      timestamp: new Date().toISOString(),
      source: window.location.href,
    };

    try {
      const response = await fetch(webhookUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      if (response.ok) {
        successMsg?.classList.remove('hidden');
        form.reset();

        // Track conversion in GTM
        if (typeof window !== 'undefined' && window.dataLayer) {
          window.dataLayer.push({
            'event': 'contact_form_submit',
            'form_name': 'contact',
            'form_location': window.location.pathname
          });
        }
      } else {
        throw new Error('Failed to send');
      }
    } catch (error) {
      errorMsg?.classList.remove('hidden');
    } finally {
      // Reset button state
      btnText.textContent = pageLang === 'fr' ? 'Envoyer le Message' : 'Send Message';
      btnIcon?.classList.remove('hidden');
      btnSpinner?.classList.add('hidden');
      submitBtn.disabled = false;
    }
  });
</script>
