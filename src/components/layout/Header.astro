---
import { languages, type Language } from '@/i18n/config';
import { t } from '@/i18n/utils';
import Button from '@/components/ui/Button.astro';
import Icon from '@/components/ui/Icon.astro';

interface Props {
  lang: Language;
}

const { lang } = Astro.props;

const currentPath = Astro.url.pathname;
const pathWithoutLang = currentPath.replace(/^\/(en|fr)/, '');

// Navigation structure
const navigation = [
  {
    label: t(lang, 'nav.services'),
    href: `/${lang}/services`,
    children: [
      { label: 'Google Ads', href: `/${lang}/services/google-ads` },
      { label: 'Paid Social', href: `/${lang}/services/paid-social` },
      { label: 'SEO', href: `/${lang}/services/seo` },
      { label: 'Emailing', href: `/${lang}/services/emailing` },
      { label: 'B2B / ABM', href: `/${lang}/services/b2b-abm` },
    ],
  },
  {
    label: t(lang, 'nav.ai'),
    href: `/${lang}/ai`,
    children: [
      { label: 'AI Training', href: `/${lang}/services/ai-training` },
      { label: 'AI Solutions', href: `/${lang}/services/ai-solutions` },
      { label: 'AI Content', href: `/${lang}/services/ai-content` },
    ],
  },
  {
    label: t(lang, 'nav.automotive'),
    href: `/${lang}/automotive`,
    children: [
      { label: 'Google Ads', href: `/${lang}/automotive/google-ads` },
      { label: 'Paid Social', href: `/${lang}/automotive/paid-social` },
      { label: 'Dynamic Ads', href: `/${lang}/automotive/dynamic-ads` },
    ],
  },
  { label: t(lang, 'nav.caseStudies'), href: `/${lang}/case-studies` },
  { label: t(lang, 'nav.blog'), href: `/${lang}/blog` },
];

const alternateLang = lang === 'en' ? 'fr' : 'en';
const alternateUrl = `/${alternateLang}${pathWithoutLang}`;
---

<header class="fixed top-0 left-0 right-0 z-50 bg-white/95 backdrop-blur-sm border-b border-slate-100" id="header">
  <nav class="container-custom h-18 flex items-center justify-between">
    <!-- Logo -->
    <a href={`/${lang}`} class="flex items-center group">
      <img
        src="/images/Logos/MyDigipal Logo_Full Main.png"
        alt="MyDigipal"
        class="h-8 w-auto group-hover:scale-105 transition-transform"
      />
    </a>

    <!-- Desktop Navigation -->
    <div class="hidden lg:flex items-center gap-1">
      {navigation.map((item) => (
        <div class="relative group">
          <a
            href={item.href}
            class={`
              flex items-center gap-1 px-4 py-2 text-sm font-medium rounded-lg transition-colors
              ${currentPath.startsWith(item.href) ? 'text-primary-500 bg-primary-50' : 'text-slate-600 hover:text-slate-900 hover:bg-slate-50'}
            `}
          >
            {item.label}
            {item.children && (
              <Icon name="chevron-down" size={16} class="transition-transform group-hover:rotate-180" />
            )}
          </a>

          {item.children && (
            <div class="absolute top-full left-0 pt-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
              <div class="bg-white rounded-xl shadow-strong border border-slate-100 py-2 min-w-[220px]">
                {item.children.map((child) => (
                  <a
                    href={child.href}
                    class={`
                      block px-4 py-2.5 text-sm transition-colors
                      ${currentPath === child.href ? 'text-primary-500 bg-primary-50' : 'text-slate-600 hover:text-slate-900 hover:bg-slate-50'}
                    `}
                  >
                    {child.label}
                  </a>
                ))}
              </div>
            </div>
          )}
        </div>
      ))}
    </div>

    <!-- Right side -->
    <div class="flex items-center gap-3">
      <!-- Contact Button -->
      <a
        href={`/${lang}/contact`}
        class="hidden sm:flex items-center px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-slate-50 rounded-lg transition-colors"
      >
        {t(lang, 'nav.contact')}
      </a>

      <!-- Quote Button -->
      <Button href={`/${lang}/calculator`} variant="primary" size="sm" class="hidden sm:inline-flex">
        {t(lang, 'nav.quote')}
      </Button>

      <!-- Language switcher -->
      <a
        href={alternateUrl}
        class="hidden sm:flex items-center gap-2 px-3 py-2 text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-slate-50 rounded-lg transition-colors"
        title={languages[alternateLang].name}
      >
        <span>{languages[alternateLang].flag}</span>
        <span class="hidden md:inline">{languages[alternateLang].code.toUpperCase()}</span>
      </a>

      <!-- Mobile menu button -->
      <button
        type="button"
        class="lg:hidden p-2 text-slate-600 hover:text-slate-900 hover:bg-slate-50 rounded-lg transition-colors"
        id="mobile-menu-btn"
        aria-label="Toggle menu"
      >
        <Icon name="menu" size={24} id="menu-icon" />
        <Icon name="close" size={24} id="close-icon" class="hidden" />
      </button>
    </div>
  </nav>

  <!-- Mobile Navigation -->
  <div class="lg:hidden hidden max-h-[calc(100vh-4.5rem)] overflow-y-auto" id="mobile-menu">
    <div class="container-custom py-4 border-t border-slate-100 bg-white">
      <div class="space-y-1">
        {navigation.map((item, index) => (
          <div class="mobile-nav-item">
            {item.children ? (
              <>
                <div class="flex items-center gap-1">
                  <button
                    type="button"
                    class="mobile-submenu-toggle flex-1 flex items-center justify-between px-4 py-3 text-base font-medium rounded-lg transition-colors text-slate-600 hover:text-slate-900 hover:bg-slate-50 text-left"
                    data-submenu={`mobile-submenu-${index}`}
                  >
                    <span>{item.label}</span>
                    <Icon name="chevron-down" size={18} class="submenu-chevron transition-transform duration-200" />
                  </button>
                  <a
                    href={item.href}
                    class="flex-shrink-0 p-3 text-slate-400 hover:text-primary-600 hover:bg-primary-50 rounded-lg transition-colors"
                    title={lang === 'fr' ? 'Voir tout' : 'View all'}
                  >
                    <Icon name="arrow-right" size={18} />
                  </a>
                </div>
                <div
                  id={`mobile-submenu-${index}`}
                  class="mobile-submenu hidden ml-4 mt-1 space-y-1 pl-4 border-l-2 border-slate-100"
                >
                  {item.children.map((child) => (
                    <a
                      href={child.href}
                      class={`
                        block px-4 py-2.5 text-sm rounded-lg transition-colors
                        ${currentPath === child.href ? 'text-primary-500 bg-primary-50' : 'text-slate-500 hover:text-slate-900 hover:bg-slate-50'}
                      `}
                    >
                      {child.label}
                    </a>
                  ))}
                </div>
              </>
            ) : (
              <a
                href={item.href}
                class={`
                  flex items-center px-4 py-3 text-base font-medium rounded-lg transition-colors
                  ${currentPath.startsWith(item.href) ? 'text-primary-500 bg-primary-50' : 'text-slate-600 hover:text-slate-900 hover:bg-slate-50'}
                `}
              >
                {item.label}
              </a>
            )}
          </div>
        ))}
      </div>

      <div class="mt-4 pt-4 border-t border-slate-100 flex flex-col gap-3">
        <div class="flex items-center gap-3">
          <a
            href={`/${lang}/contact`}
            class="flex-1 flex items-center justify-center px-4 py-3 text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-slate-50 rounded-lg transition-colors border border-slate-200"
          >
            {t(lang, 'nav.contact')}
          </a>
          <Button href={`/${lang}/calculator`} variant="primary" class="flex-1">
            {t(lang, 'nav.quote')}
          </Button>
        </div>
        <a
          href={alternateUrl}
          class="flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-slate-50 rounded-lg transition-colors"
        >
          <span>{languages[alternateLang].flag}</span>
          <span>{languages[alternateLang].name}</span>
        </a>
      </div>
    </div>
  </div>
</header>

<!-- Spacer for fixed header -->
<div class="h-18"></div>

<script is:inline>
  // Mobile menu toggle - using event delegation for robustness
  (function() {
    function handleMobileMenu(e) {
      // Check if click is on the mobile menu button or its children
      const btn = e.target.closest('#mobile-menu-btn');
      if (!btn) return;

      e.preventDefault();
      e.stopPropagation();

      const menu = document.getElementById('mobile-menu');
      const menuIcon = document.getElementById('menu-icon');
      const closeIcon = document.getElementById('close-icon');

      if (!menu || !menuIcon || !closeIcon) return;

      const isOpen = !menu.classList.contains('hidden');

      if (isOpen) {
        menu.classList.add('hidden');
        menuIcon.classList.remove('hidden');
        closeIcon.classList.add('hidden');
        // Close all submenus when closing main menu
        document.querySelectorAll('.mobile-submenu').forEach(function(sub) {
          sub.classList.add('hidden');
        });
        document.querySelectorAll('.submenu-chevron').forEach(function(chev) {
          chev.style.transform = '';
        });
      } else {
        menu.classList.remove('hidden');
        menuIcon.classList.add('hidden');
        closeIcon.classList.remove('hidden');
      }
    }

    function handleSubmenuToggle(e) {
      const toggleBtn = e.target.closest('.mobile-submenu-toggle');
      if (!toggleBtn) return;

      e.preventDefault();
      e.stopPropagation();

      const submenuId = toggleBtn.getAttribute('data-submenu');
      const submenu = document.getElementById(submenuId);
      const chevron = toggleBtn.querySelector('.submenu-chevron');

      if (!submenu) return;

      const isOpen = !submenu.classList.contains('hidden');

      if (isOpen) {
        submenu.classList.add('hidden');
        if (chevron) chevron.style.transform = '';
      } else {
        submenu.classList.remove('hidden');
        if (chevron) chevron.style.transform = 'rotate(180deg)';
      }
    }

    function handleOutsideClick(e) {
      const menu = document.getElementById('mobile-menu');
      const header = document.getElementById('header');
      const menuIcon = document.getElementById('menu-icon');
      const closeIcon = document.getElementById('close-icon');

      if (!menu || !header || menu.classList.contains('hidden')) return;

      // If click is outside the header, close the menu
      if (!header.contains(e.target)) {
        menu.classList.add('hidden');
        if (menuIcon) menuIcon.classList.remove('hidden');
        if (closeIcon) closeIcon.classList.add('hidden');
        // Close all submenus
        document.querySelectorAll('.mobile-submenu').forEach(function(sub) {
          sub.classList.add('hidden');
        });
        document.querySelectorAll('.submenu-chevron').forEach(function(chev) {
          chev.style.transform = '';
        });
      }
    }

    // Use event delegation on document - works with View Transitions
    document.addEventListener('click', function(e) {
      handleMobileMenu(e);
      handleSubmenuToggle(e);
    }, true); // Use capture phase

    document.addEventListener('click', handleOutsideClick);

    // Also handle touch events for mobile
    document.addEventListener('touchend', function(e) {
      handleMobileMenu(e);
      handleSubmenuToggle(e);
    }, true);
  })();
</script>
