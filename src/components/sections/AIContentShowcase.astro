---
import { type Language } from '@/i18n/config';
import Icon from '@/components/ui/Icon.astro';

interface Props {
  lang: Language;
  color?: 'seo' | 'ads' | 'social' | 'abm' | 'primary';
}

const { lang, color = 'seo' } = Astro.props;

const colorConfig = {
  seo: {
    gradient: 'from-emerald-500 to-teal-600',
    text: 'text-emerald-500',
    bg: 'bg-emerald-500',
  },
  ads: {
    gradient: 'from-amber-500 to-orange-600',
    text: 'text-amber-500',
    bg: 'bg-amber-500',
  },
  social: {
    gradient: 'from-violet-500 to-purple-600',
    text: 'text-violet-500',
    bg: 'bg-violet-500',
  },
  abm: {
    gradient: 'from-pink-500 to-rose-600',
    text: 'text-pink-500',
    bg: 'bg-pink-500',
  },
  primary: {
    gradient: 'from-blue-500 to-indigo-600',
    text: 'text-blue-500',
    bg: 'bg-blue-500',
  },
};

const colors = colorConfig[color];

const content = {
  en: {
    badge: 'Phase 3 - Game Changer',
    title: 'AI-Powered Content Production',
    subtitle: 'Our secret weapon: automated content that sounds like YOU, optimized by data, published at scale',
    metrics: [
      { prefix: '+', value: '68', suffix: '%', label: 'Organic Traffic', description: 'increase with this process' },
      { prefix: '', value: '3', suffix: 'h', label: 'Saved per Article', description: 'vs. traditional creation' },
      { prefix: '', value: '74', suffix: '%', label: 'LLM Visibility', description: 'on ChatGPT, Gemini, Perplexity' },
    ],
    features: {
      title: 'Why Our AI Content Is Different',
      items: [
        {
          icon: 'sparkles',
          title: 'Trained on YOUR Voice',
          description: 'Our AI learns your brand guidelines, tone, vocabulary, and writing style. Every article sounds authentically YOU, not like a robot.',
        },
        {
          icon: 'bar-chart',
          title: 'Powered by Ahrefs Data',
          description: 'Real-time keyword research, difficulty scoring, and competitive analysis feed directly into content strategy. No guessing.',
        },
        {
          icon: 'trending-up',
          title: 'Search Console Integration',
          description: 'We connect to your GSC to identify what\'s already working, find quick wins, and optimize for queries you\'re close to ranking.',
        },
        {
          icon: 'target',
          title: 'SEO-First Structure',
          description: 'Every article follows optimal structure: H1-H6 hierarchy, FAQ sections for featured snippets, internal linking, and schema markup.',
        },
      ],
    },
    process: {
      title: 'The Process',
      steps: [
        {
          number: '01',
          title: 'Topic Identification',
          description: 'We analyze trends, your priorities, and SEO opportunities to identify high-impact topics.',
        },
        {
          number: '02',
          title: 'Use of External SEO Data',
          description: 'Real-time keyword research powered by Ahrefs, competitive analysis feed directly into content strategy. No guessing.',
        },
        {
          number: '03',
          title: 'Use of Internal SEO Data',
          description: 'We connect to your Search Console to identify what\'s already working, find quick wins, and optimize for queries you\'re close to ranking.',
        },
        {
          number: '04',
          title: 'AI Article Generation',
          description: 'Claude Sonnet 4 / GPT-5 generates content trained on your brand voice and SEO best practices.',
        },
      ],
    },
    deliveryOptions: {
      title: 'Delivery Options',
      subtitle: 'Choose how you want to receive your content',
      options: [
        {
          icon: 'file-text',
          title: 'CMS Draft',
          description: 'We push directly to your CMS as a draft. You review, edit if needed, and publish when ready.',
          color: 'blue',
        },
        {
          icon: 'zap',
          title: 'Direct Publish',
          description: 'We publish directly to your CMS following your editorial calendar. Fully hands-off.',
          color: 'green',
        },
        {
          icon: 'mail',
          title: 'Complete Document',
          description: 'We deliver a comprehensive document with all elements ready for your team to implement.',
          color: 'purple',
        },
      ],
    },
    deliverables: {
      title: "What's Included",
      subtitle: 'Every article comes with a complete package',
      items: [
        { label: 'Meta Title', detail: 'max 60 characters' },
        { label: 'Meta Description', detail: 'max 155 characters' },
        { label: 'H1 + 4-7 H2', detail: 'optimized structure' },
        { label: 'Primary Keyword', detail: '+ ~5 secondary keywords' },
        { label: 'Internal Links', detail: '8-12 strategic links' },
        { label: 'Strategy Rationale', detail: 'reasoning behind choices' },
        { label: 'Complete Article', detail: 'formatted for your CMS' },
        { label: 'Brand Compliance', detail: 'matches your guidelines' },
      ],
    },
    comparison: {
      title: 'Traditional vs. Our Approach',
      traditional: {
        label: 'Traditional Agency',
        items: [
          '100% generic ChatGPT output',
          'Keyword stuffing (5%+ density)',
          '500-word thin content',
          'No tracking after publish',
          '1 article/week max',
        ],
      },
      ours: {
        label: 'MyDigipal AI',
        items: [
          'Custom-trained AI + human review',
          'Natural density (1-2%)',
          '1500+ word comprehensive guides',
          'Continuous performance monitoring',
          '2-4 articles/week',
        ],
      },
    },
    cta: {
      title: 'Ready to Scale Your Content?',
      description: 'Join 50+ companies already dominating their niches with AI-powered content.',
      button: 'Start Your Content Engine',
    },
  },
  fr: {
    badge: 'Phase 3 - Game Changer',
    title: 'Production de Contenu IA',
    subtitle: 'Notre arme secrète : du contenu automatisé qui sonne comme VOUS, optimisé par la data, publié à grande échelle',
    metrics: [
      { prefix: '+', value: '68', suffix: '%', label: 'Trafic Organique', description: 'augmentation avec ce process' },
      { prefix: '', value: '3', suffix: 'h', label: 'Économisées par Article', description: 'vs. création traditionnelle' },
      { prefix: '', value: '74', suffix: '%', label: 'Visibilité LLM', description: 'sur ChatGPT, Gemini, Perplexity' },
    ],
    features: {
      title: 'Pourquoi Notre Contenu IA Est Différent',
      items: [
        {
          icon: 'sparkles',
          title: 'Entraîné sur VOTRE Voix',
          description: 'Notre IA apprend vos guidelines de marque, ton, vocabulaire et style d\'écriture. Chaque article sonne authentiquement VOUS, pas comme un robot.',
        },
        {
          icon: 'bar-chart',
          title: 'Propulsé par Ahrefs',
          description: 'Recherche de mots-clés en temps réel, scoring de difficulté et analyse concurrentielle alimentent directement la stratégie de contenu.',
        },
        {
          icon: 'trending-up',
          title: 'Intégration Search Console',
          description: 'Nous connectons votre GSC pour identifier ce qui marche, trouver les quick wins, et optimiser pour les requêtes proches du top.',
        },
        {
          icon: 'target',
          title: 'Structure SEO-First',
          description: 'Chaque article suit une structure optimale : hiérarchie H1-H6, sections FAQ pour featured snippets, maillage interne, et balisage schema.',
        },
      ],
    },
    process: {
      title: 'Le Process',
      steps: [
        {
          number: '01',
          title: 'Identification des Sujets',
          description: 'Nous analysons les tendances, vos priorités et opportunités SEO pour identifier les sujets à fort impact.',
        },
        {
          number: '02',
          title: 'Utilisation de Données SEO Externes',
          description: 'Recherche de mots-clés en temps réel via Ahrefs, analyse concurrentielle qui alimentent directement la stratégie de contenu.',
        },
        {
          number: '03',
          title: 'Utilisation de Données SEO Internes',
          description: 'Nous connectons votre Search Console pour identifier ce qui marche, trouver les quick wins, et optimiser pour les requêtes proches du top.',
        },
        {
          number: '04',
          title: 'Génération IA',
          description: 'Claude Sonnet 4 / GPT-5 génère le contenu entraîné sur votre voix de marque et meilleures pratiques SEO.',
        },
      ],
    },
    deliveryOptions: {
      title: 'Options de Livraison',
      subtitle: 'Choisissez comment recevoir votre contenu',
      options: [
        {
          icon: 'file-text',
          title: 'Brouillon CMS',
          description: 'Nous poussons directement dans votre CMS en brouillon. Vous relisez, modifiez si besoin, et publiez.',
          color: 'blue',
        },
        {
          icon: 'zap',
          title: 'Publication Directe',
          description: 'Nous publions directement dans votre CMS selon votre calendrier éditorial. 100% hands-off.',
          color: 'green',
        },
        {
          icon: 'mail',
          title: 'Document Complet',
          description: 'Nous livrons un document complet avec tous les éléments prêts pour votre équipe.',
          color: 'purple',
        },
      ],
    },
    deliverables: {
      title: "Ce Qui Est Inclus",
      subtitle: 'Chaque article vient avec un package complet',
      items: [
        { label: 'Meta Title', detail: 'max 60 caractères' },
        { label: 'Meta Description', detail: 'max 155 caractères' },
        { label: 'H1 + 4-7 H2', detail: 'structure optimisée' },
        { label: 'Mot-clé Principal', detail: '+ ~5 mots-clés secondaires' },
        { label: 'Liens Internes', detail: '8-12 liens stratégiques' },
        { label: 'Raisonnement Stratégique', detail: 'justification des choix' },
        { label: 'Article Complet', detail: 'formaté pour votre CMS' },
        { label: 'Conformité Marque', detail: 'respecte vos guidelines' },
      ],
    },
    comparison: {
      title: 'Traditionnel vs. Notre Approche',
      traditional: {
        label: 'Agence Traditionnelle',
        items: [
          '100% output ChatGPT générique',
          'Keyword stuffing (5%+ densité)',
          'Contenu léger de 500 mots',
          'Pas de suivi après publication',
          '1 article/semaine max',
        ],
      },
      ours: {
        label: 'MyDigipal IA',
        items: [
          'IA personnalisée + revue humaine',
          'Densité naturelle (1-2%)',
          'Guides complets de 1500+ mots',
          'Monitoring performance continu',
          '2-4 articles/semaine',
        ],
      },
    },
    cta: {
      title: 'Prêt à Scaler Votre Contenu ?',
      description: 'Rejoignez 50+ entreprises qui dominent déjà leurs niches avec du contenu IA.',
      button: 'Lancez Votre Machine à Contenu',
    },
  },
};

const t = content[lang];
---

<section class="relative py-24 bg-slate-950 overflow-hidden">
  <!-- Background Effects -->
  <div class="absolute inset-0 overflow-hidden">
    <div class={`absolute top-1/4 -left-32 w-96 h-96 bg-gradient-to-br ${colors.gradient} rounded-full opacity-10 blur-3xl animate-pulse`}></div>
    <div class="absolute bottom-1/4 -right-32 w-96 h-96 bg-gradient-to-br from-purple-500 to-pink-600 rounded-full opacity-10 blur-3xl animate-pulse" style="animation-delay: 1s;"></div>
    <div class="absolute inset-0" style="background-image: radial-gradient(rgba(255,255,255,0.03) 1px, transparent 1px); background-size: 40px 40px;"></div>
  </div>

  <div class="container-custom relative z-10">
    <!-- Section Header -->
    <div class="text-center max-w-4xl mx-auto mb-20">
      <span class={`inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-semibold bg-gradient-to-r ${colors.gradient} text-white mb-6`}>
        <Icon name="zap" size={16} />
        {t.badge}
      </span>
      <h2 class="text-4xl lg:text-6xl font-bold text-white mb-6">
        {t.title}
      </h2>
      <p class="text-xl text-slate-400">
        {t.subtitle}
      </p>
    </div>

    <!-- Metrics Grid - 3 big cards -->
    <div class="grid md:grid-cols-3 gap-8 mb-24 max-w-5xl mx-auto" id="metrics-grid">
      {t.metrics.map((metric, index) => (
        <div
          class="metric-card group relative bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-2xl p-8 text-center hover:border-slate-700 transition-all duration-300 hover:transform hover:-translate-y-2"
          style={`animation-delay: ${index * 100}ms`}
          data-value={metric.value}
          data-prefix={metric.prefix || ''}
        >
          <div class={`text-5xl lg:text-6xl font-bold bg-gradient-to-r ${colors.gradient} bg-clip-text text-transparent mb-3`}>
            <span class="metric-prefix">{metric.prefix || ''}</span><span class="metric-value">0</span>{metric.suffix}
          </div>
          <div class="text-white font-semibold text-lg mb-2">{metric.label}</div>
          <div class="text-slate-400">{metric.description}</div>
        </div>
      ))}
    </div>

    <!-- Features Grid -->
    <div class="mb-24">
      <h3 class="text-2xl lg:text-3xl font-bold text-white text-center mb-12">
        {t.features.title}
      </h3>
      <div class="grid md:grid-cols-2 gap-6">
        {t.features.items.map((feature, index) => (
          <div
            class="feature-item group relative bg-gradient-to-br from-slate-900 to-slate-900/50 border border-slate-800 rounded-2xl p-8 hover:border-slate-700 transition-all duration-500"
            style={`animation-delay: ${index * 100}ms`}
          >
            <div class={`w-14 h-14 rounded-xl bg-gradient-to-br ${colors.gradient} flex items-center justify-center text-white mb-6 group-hover:scale-110 transition-transform duration-300`}>
              <Icon name={feature.icon} size={28} />
            </div>
            <h4 class="text-xl font-bold text-white mb-3">{feature.title}</h4>
            <p class="text-slate-400 leading-relaxed">{feature.description}</p>
          </div>
        ))}
      </div>
    </div>

    <!-- Process Timeline -->
    <div class="mb-24 process-container" id="process-container">
      <h3 class="text-2xl lg:text-3xl font-bold text-white text-center mb-12">
        {t.process.title}
      </h3>
      <div class="relative">
        <!-- Progress bar (centered through circles) -->
        <div class="hidden lg:block absolute left-0 right-0 h-1.5 bg-slate-800 rounded-full overflow-visible z-0" style="top: 30px;">
          <div class={`process-progress-bar h-full bg-gradient-to-r ${colors.gradient} rounded-full`} style="width: 0%; transition: width 0.1s linear;"></div>
        </div>

        <div class="grid lg:grid-cols-4 gap-8 mb-12 relative z-10">
          {t.process.steps.map((step, index) => (
            <div class="process-step relative text-center lg:text-left" data-step={index + 1} style={`animation-delay: ${index * 150}ms`}>
              <div class="relative inline-flex lg:block">
                <div class={`step-circle w-16 h-16 rounded-full bg-slate-900 border-4 border-slate-700 flex items-center justify-center text-2xl font-bold ${colors.text} mx-auto lg:mx-0 mb-4 transition-all duration-300 relative z-20`}>
                  {step.number}
                </div>
              </div>
              <h4 class="text-lg font-bold text-white mb-2">{step.title}</h4>
              <p class="text-slate-400 text-sm">{step.description}</p>
            </div>
          ))}
        </div>

        <!-- Delivery Options Branch -->
        <div class="delivery-section relative mt-16 lg:mt-8" id="delivery-section">
          <!-- Delivery Options Header Box -->
          <div class="delivery-header-box flex justify-center mb-10 opacity-0 translate-y-4">
            <div class={`inline-block px-8 py-6 rounded-2xl bg-gradient-to-br from-slate-800 to-slate-900 border-2 border-emerald-500/50 shadow-lg shadow-emerald-500/10`}>
              <div class="flex items-center justify-center gap-3 mb-2">
                <span class={`w-3 h-3 rounded-full ${colors.bg} animate-pulse`}></span>
                <span class="text-white text-lg font-bold">{t.deliveryOptions.title}</span>
              </div>
              <p class="text-slate-400 text-sm text-center">{t.deliveryOptions.subtitle}</p>
            </div>
          </div>

          <!-- 3 Delivery Options with staggered animation -->
          <div class="grid md:grid-cols-3 gap-6">
            {t.deliveryOptions.options.map((option, index) => (
              <div
                class={`delivery-option group relative bg-slate-900/80 border border-slate-700 rounded-2xl p-6 text-center hover:border-slate-600 transition-all duration-300 hover:-translate-y-2 opacity-0 translate-y-8 ${
                  option.color === 'blue' ? 'hover:border-blue-500/50' :
                  option.color === 'green' ? 'hover:border-emerald-500/50' :
                  'hover:border-purple-500/50'
                }`}
                data-delay={index}
              >
                <div class={`w-12 h-12 rounded-xl mx-auto mb-4 flex items-center justify-center ${
                  option.color === 'blue' ? 'bg-blue-500/20 text-blue-400' :
                  option.color === 'green' ? 'bg-emerald-500/20 text-emerald-400' :
                  'bg-purple-500/20 text-purple-400'
                }`}>
                  <Icon name={option.icon} size={24} />
                </div>
                <h5 class="text-lg font-bold text-white mb-2">{option.title}</h5>
                <p class="text-slate-400 text-sm">{option.description}</p>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>

    <!-- What's Included -->
    <div class="mb-24">
      <div class="text-center mb-12">
        <h3 class="text-2xl lg:text-3xl font-bold text-white mb-4">
          {t.deliverables.title}
        </h3>
        <p class="text-slate-400">{t.deliverables.subtitle}</p>
      </div>

      <!-- Row 1: 3 items -->
      <div class="grid md:grid-cols-3 gap-5 mb-5">
        {t.deliverables.items.slice(0, 3).map((item, index) => (
          <div
            class="deliverable-item bg-slate-900/50 border border-slate-800 rounded-xl p-6 text-center hover:border-slate-700 transition-all duration-300"
            style={`animation-delay: ${index * 50}ms`}
          >
            <div class={`text-lg font-bold ${colors.text} mb-2`}>{item.label}</div>
            <div class="text-base text-slate-400">{item.detail}</div>
          </div>
        ))}
      </div>

      <!-- Row 2: 3 items -->
      <div class="grid md:grid-cols-3 gap-5 mb-5">
        {t.deliverables.items.slice(3, 6).map((item, index) => (
          <div
            class="deliverable-item bg-slate-900/50 border border-slate-800 rounded-xl p-6 text-center hover:border-slate-700 transition-all duration-300"
            style={`animation-delay: ${(index + 3) * 50}ms`}
          >
            <div class={`text-lg font-bold ${colors.text} mb-2`}>{item.label}</div>
            <div class="text-base text-slate-400">{item.detail}</div>
          </div>
        ))}
      </div>

      <!-- Row 3: 2 items centered -->
      <div class="grid md:grid-cols-2 gap-5 max-w-2xl mx-auto">
        {t.deliverables.items.slice(6, 8).map((item, index) => (
          <div
            class="deliverable-item bg-slate-900/50 border border-slate-800 rounded-xl p-6 text-center hover:border-slate-700 transition-all duration-300"
            style={`animation-delay: ${(index + 6) * 50}ms`}
          >
            <div class={`text-lg font-bold ${colors.text} mb-2`}>{item.label}</div>
            <div class="text-base text-slate-400">{item.detail}</div>
          </div>
        ))}
      </div>
    </div>

    <!-- Comparison Section -->
    <div class="mb-24">
      <h3 class="text-2xl lg:text-3xl font-bold text-white text-center mb-12">
        {t.comparison.title}
      </h3>
      <div class="grid md:grid-cols-2 gap-6 max-w-4xl mx-auto">
        <!-- Traditional -->
        <div class="bg-slate-900/50 border border-red-900/30 rounded-2xl p-8">
          <div class="flex items-center gap-3 mb-6">
            <div class="w-10 h-10 rounded-full bg-red-900/30 flex items-center justify-center">
              <svg class="w-5 h-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </div>
            <span class="text-lg font-semibold text-slate-300">{t.comparison.traditional.label}</span>
          </div>
          <ul class="space-y-3">
            {t.comparison.traditional.items.map((item) => (
              <li class="flex items-start gap-3 text-slate-400">
                <svg class="w-5 h-5 flex-shrink-0 mt-0.5 text-red-500/70" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                </svg>
                <span>{item}</span>
              </li>
            ))}
          </ul>
        </div>

        <!-- Ours -->
        <div class={`bg-gradient-to-br from-slate-900 to-slate-800 border border-emerald-900/50 rounded-2xl p-8 relative overflow-hidden`}>
          <div class={`absolute top-0 right-0 w-32 h-32 bg-gradient-to-br ${colors.gradient} opacity-10 blur-2xl`}></div>
          <div class="relative">
            <div class="flex items-center gap-3 mb-6">
              <div class={`w-10 h-10 rounded-full bg-gradient-to-br ${colors.gradient} flex items-center justify-center`}>
                <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
              </div>
              <span class="text-lg font-semibold text-white">{t.comparison.ours.label}</span>
            </div>
            <ul class="space-y-3">
              {t.comparison.ours.items.map((item) => (
                <li class="flex items-start gap-3 text-slate-300">
                  <svg class={`w-5 h-5 flex-shrink-0 mt-0.5 ${colors.text}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  <span>{item}</span>
                </li>
              ))}
            </ul>
          </div>
        </div>
      </div>
    </div>

  </div>
</section>

<style>
  .metric-card,
  .feature-item,
  .process-step,
  .deliverable-item {
    animation: fade-up 0.6s ease forwards;
    opacity: 0;
    transform: translateY(30px);
  }

  @keyframes fade-up {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Step circle active state */
  .step-circle.active {
    border-color: #10B981 !important;
    box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
  }

  /* Delivery header box animation */
  .delivery-header-box.visible {
    animation: pop-scale 0.5s ease forwards;
  }

  @keyframes pop-scale {
    0% {
      opacity: 0;
      transform: translateY(20px) scale(0.9);
    }
    100% {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  /* Delivery options staggered animation */
  .delivery-option.visible {
    animation: pop-in 0.4s ease forwards;
  }

  @keyframes pop-in {
    0% {
      opacity: 0;
      transform: translateY(30px) scale(0.9);
    }
    100% {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
</style>

<script>
  // Animated counters - robust implementation
  function animateValue(el: Element, start: number, end: number, duration: number) {
    const range = end - start;
    const startTime = performance.now();

    function update(currentTime: number) {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const easeProgress = 1 - Math.pow(1 - progress, 3);
      const current = Math.round(start + range * easeProgress);
      el.textContent = current.toString();

      if (progress < 1) {
        requestAnimationFrame(update);
      }
    }

    requestAnimationFrame(update);
  }

  function triggerCounterAnimation(card: HTMLElement) {
    const valueEl = card.querySelector('.metric-value');
    const targetValue = parseInt(card.dataset.value || '0');

    if (valueEl && !card.classList.contains('counted')) {
      card.classList.add('counted');
      animateValue(valueEl, 0, targetValue, 1500);
    }
  }

  function checkMetricsVisibility() {
    const metricsGrid = document.getElementById('metrics-grid');
    if (!metricsGrid) return;

    const rect = metricsGrid.getBoundingClientRect();
    const isVisible = rect.top < window.innerHeight && rect.bottom > 0;

    if (isVisible) {
      document.querySelectorAll('.metric-card').forEach((card) => {
        triggerCounterAnimation(card as HTMLElement);
      });
    }
  }

  // Check on scroll
  let metricsChecked = false;
  window.addEventListener('scroll', () => {
    if (!metricsChecked) {
      checkMetricsVisibility();
      // Check if all are counted
      const cards = document.querySelectorAll('.metric-card');
      const countedCards = document.querySelectorAll('.metric-card.counted');
      if (cards.length === countedCards.length) {
        metricsChecked = true;
      }
    }
  }, { passive: true });

  // Also check on load and after a short delay
  window.addEventListener('load', () => {
    setTimeout(checkMetricsVisibility, 100);
    setTimeout(checkMetricsVisibility, 500);
    setTimeout(checkMetricsVisibility, 1000);
  });

  // Immediate check
  checkMetricsVisibility();

  // Progress bar scroll animation
  const processContainer = document.getElementById('process-container');
  const progressBar = document.querySelector('.process-progress-bar') as HTMLElement;
  const stepCircles = document.querySelectorAll('.step-circle');
  const deliveryHeaderBox = document.querySelector('.delivery-header-box');
  const deliveryOptions = document.querySelectorAll('.delivery-option');

  let deliveryAnimationTriggered = false;

  function updateProgressBar() {
    if (!processContainer || !progressBar) return;

    const containerRect = processContainer.getBoundingClientRect();
    const viewportHeight = window.innerHeight;

    // Calculate how much of the process section is visible
    const containerTop = containerRect.top;

    // Start filling when container enters viewport, complete when fully visible
    const startPoint = viewportHeight * 0.7;
    const endPoint = viewportHeight * 0.3;

    // Calculate progress (0 to 1)
    let progress = 0;
    if (containerTop < startPoint) {
      progress = (startPoint - containerTop) / (startPoint - endPoint);
      progress = Math.max(0, Math.min(1, progress));
    }

    // Update progress bar width
    progressBar.style.width = `${progress * 100}%`;

    // Update step circles based on progress
    const stepsActivated = Math.floor(progress * 4);
    stepCircles.forEach((circle, index) => {
      if (index < stepsActivated) {
        circle.classList.add('active');
      } else {
        circle.classList.remove('active');
      }
    });

    // When progress reaches 100% (step 4 complete), show delivery options
    if (progress >= 1 && !deliveryAnimationTriggered) {
      deliveryAnimationTriggered = true;

      // Activate step 4
      stepCircles[3]?.classList.add('active');

      // Show delivery header box immediately
      setTimeout(() => {
        deliveryHeaderBox?.classList.add('visible');
      }, 200);

      // Show delivery options one by one
      deliveryOptions.forEach((option, index) => {
        setTimeout(() => {
          option.classList.add('visible');
        }, 600 + (index * 200));
      });
    }
  }

  // Listen to scroll events
  let ticking = false;
  window.addEventListener('scroll', () => {
    if (!ticking) {
      requestAnimationFrame(() => {
        updateProgressBar();
        ticking = false;
      });
      ticking = true;
    }
  });

  // Initial check
  updateProgressBar();
</script>
