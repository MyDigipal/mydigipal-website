---
/**
 * TrustedBy - Animated client logo showcase
 * Infinite scrolling carousel with drag functionality
 */
import type { Language } from '@/i18n/config';

interface Props {
  lang: Language;
  variant?: 'default' | 'compact' | 'featured';
  showCount?: boolean;
}

const { lang, variant = 'default', showCount = true } = Astro.props;

const content = {
  en: {
    badge: 'Trusted Partners',
    title: 'Trusted by Industry Leaders',
    subtitle: 'From startups to enterprises, we help businesses grow with data-driven digital marketing.',
    count: '50+',
    countLabel: 'Happy Clients',
    cta: 'Join them →',
  },
  fr: {
    badge: 'Partenaires de Confiance',
    title: 'Ils Nous Font Confiance',
    subtitle: 'Des startups aux grandes entreprises, nous aidons les businesses à croître avec du marketing digital data-driven.',
    count: '50+',
    countLabel: 'Clients Satisfaits',
    cta: 'Rejoignez-les →',
  },
};

const t = content[lang] || content.en;

// Client logos - categories from MyDigipal Client list.csv
const clients = [
  { name: 'Genesys', logo: '/images/Client logo/genesys-vector-logo.png', industry: 'B2B' },
  { name: 'Quantum Metrics', logo: '/images/Client logo/quantum.png', industry: 'B2C' },
  { name: 'Theobald', logo: '/images/Client logo/theobald.png', industry: 'Automotive' },
  { name: 'OpenText', logo: '/images/Client logo/opentext-logo.png', industry: 'B2B' },
  { name: 'Edenred', logo: '/images/Client logo/Edenred_Logo_(depuis_2017).png', industry: 'B2B' },
  { name: 'Ford', logo: '/images/Client logo/ford.png', industry: 'Automotive' },
  { name: 'Vulcain', logo: '/images/Client logo/logo-VULCAIN.jpg', industry: 'B2C' },
  { name: 'Omilia', logo: '/images/Client logo/omilia.png', industry: 'B2C' },
  { name: 'Veesion', logo: '/images/Client logo/veesion.png', industry: 'B2B' },
  { name: 'Ubiquiti', logo: '/images/Client logo/ubiquiti.png', industry: 'B2B' },
  { name: 'Flighty', logo: '/images/Client logo/Flighty.png', industry: 'B2C' },
  { name: 'NuHerbs', logo: '/images/Client logo/nuherbs.webp', industry: 'B2B' },
  { name: 'FastSensor', logo: '/images/Client logo/fastsensor.png', industry: 'B2B' },
  { name: 'Frontline', logo: '/images/Client logo/frontline.png', industry: 'B2B' },
  { name: 'Altitude', logo: '/images/Client logo/Altitude.png', industry: 'B2B' },
  { name: 'Solita', logo: '/images/Client logo/Solita.png', industry: 'B2B' },
  { name: 'Unbound', logo: '/images/Client logo/Unbound.png', industry: 'B2C' },
  { name: 'On Train', logo: '/images/Client logo/on train.png', industry: 'B2B' },
  { name: 'CBCM', logo: '/images/Client logo/CBCM.png', industry: 'B2C' },
  { name: 'Goola', logo: '/images/Client logo/goola.png', industry: 'B2C' },
  { name: 'Pubstack', logo: '/images/Client logo/Pubstack.webp', industry: 'B2C' },
  { name: 'DMD', logo: '/images/Client logo/DMD.png', industry: 'Automotive' },
];

// Triple for seamless infinite loop
const tripleClients = [...clients, ...clients, ...clients];
---

<section class={`trusted-by overflow-hidden ${variant === 'compact' ? 'py-12' : 'section'} bg-slate-50`}>
  <div class="container-custom">
    {variant !== 'compact' && (
      <div class="text-center max-w-3xl mx-auto mb-12 animate-on-scroll">
        <span class="badge-primary mb-4">{t.badge}</span>
        <h2 class="heading-2 mb-4">{t.title}</h2>
        <p class="body-large text-slate-600">{t.subtitle}</p>
      </div>
    )}

    {variant === 'compact' && (
      <div class="flex items-center justify-between mb-8 animate-on-scroll">
        <h3 class="heading-4 text-slate-500">{t.title}</h3>
        {showCount && (
          <div class="flex items-center gap-2">
            <span class="text-3xl font-bold text-primary-500">{t.count}</span>
            <span class="text-sm text-slate-500">{t.countLabel}</span>
          </div>
        )}
      </div>
    )}

    {/* Stats row for default variant */}
    {variant === 'default' && showCount && (
      <div class="flex justify-center gap-12 mb-12 animate-on-scroll">
        <div class="text-center">
          <div class="text-5xl font-bold text-primary-500 counter" data-target="50">50+</div>
          <div class="text-sm text-slate-500 mt-1">{t.countLabel}</div>
        </div>
        <div class="text-center">
          <div class="text-5xl font-bold text-slate-900">12+</div>
          <div class="text-sm text-slate-500 mt-1">{lang === 'fr' ? 'Industries' : 'Industries'}</div>
        </div>
        <div class="text-center">
          <div class="text-5xl font-bold text-slate-900">8+</div>
          <div class="text-sm text-slate-500 mt-1">{lang === 'fr' ? 'Pays' : 'Countries'}</div>
        </div>
      </div>
    )}
  </div>

  {/* Infinite Scrolling Carousel with Drag */}
  <div class="logo-carousel relative cursor-grab active:cursor-grabbing select-none">
    {/* Gradient masks */}
    <div class="absolute left-0 top-0 bottom-0 w-20 bg-gradient-to-r from-slate-50 to-transparent z-10 pointer-events-none"></div>
    <div class="absolute right-0 top-0 bottom-0 w-20 bg-gradient-to-l from-slate-50 to-transparent z-10 pointer-events-none"></div>

    {/* First row - scrolls left */}
    <div class="logo-track scroll-left flex gap-6 py-4" data-speed="20">
      {tripleClients.map((client) => (
        <div class="logo-item flex-shrink-0">
          <div class="w-36 h-16 bg-white rounded-xl shadow-soft border border-slate-100 flex items-center justify-center p-3 transition-all duration-300 hover:shadow-lg hover:scale-105 hover:border-primary-500/30">
            <img
              src={client.logo}
              alt={client.name}
              class="max-w-full max-h-full object-contain transition-transform duration-300"
              loading="lazy"
              draggable="false"
            />
          </div>
        </div>
      ))}
    </div>

    {/* Second row - scrolls right (only for default variant) */}
    {variant === 'default' && (
      <div class="logo-track scroll-right flex gap-6 py-4 mt-2" data-speed="25">
        {[...tripleClients].reverse().map((client) => (
          <div class="logo-item flex-shrink-0">
            <div class="w-36 h-16 bg-white rounded-xl shadow-soft border border-slate-100 flex items-center justify-center p-3 transition-all duration-300 hover:shadow-lg hover:scale-105 hover:border-primary-500/30">
              <img
                src={client.logo}
                alt={client.name}
                class="max-w-full max-h-full object-contain transition-transform duration-300"
                loading="lazy"
                draggable="false"
              />
            </div>
          </div>
        ))}
      </div>
    )}
  </div>

  {/* CTA for default variant */}
  {variant === 'default' && (
    <div class="container-custom mt-12 text-center animate-on-scroll">
      <a
        href={`/${lang}/contact`}
        class="inline-flex items-center gap-2 text-primary-500 font-medium hover:text-primary-600 transition-colors group"
      >
        {t.cta}
        <svg class="w-5 h-5 transform group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
        </svg>
      </a>
    </div>
  )}
</section>

<style>
  /* Infinite scroll animation - faster */
  .logo-track {
    animation-timing-function: linear;
    animation-iteration-count: infinite;
    will-change: transform;
  }

  .scroll-left {
    animation: scroll-left 20s linear infinite;
  }

  .scroll-right {
    animation: scroll-right 25s linear infinite;
  }

  @keyframes scroll-left {
    0% {
      transform: translateX(0);
    }
    100% {
      transform: translateX(-33.333%);
    }
  }

  @keyframes scroll-right {
    0% {
      transform: translateX(-33.333%);
    }
    100% {
      transform: translateX(0);
    }
  }

  /* Pause on hover/drag */
  .logo-carousel.is-dragging .logo-track,
  .logo-carousel:hover .logo-track {
    animation-play-state: paused;
  }

  /* Logo item hover effect */
  .logo-item {
    perspective: 1000px;
  }

  .logo-item:hover {
    z-index: 10;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .scroll-left {
      animation-duration: 15s;
    }
    .scroll-right {
      animation-duration: 18s;
    }
    .logo-item > div {
      width: 120px;
      height: 50px;
    }
  }
</style>

<script>
  // Drag to scroll functionality + pause on interaction
  document.addEventListener('DOMContentLoaded', () => {
    const carousel = document.querySelector('.logo-carousel') as HTMLElement;
    if (!carousel) return;

    const tracks = carousel.querySelectorAll('.logo-track') as NodeListOf<HTMLElement>;

    let isDragging = false;
    let startX = 0;
    let dragOffset = 0;
    let currentTrack: HTMLElement | null = null;
    let animationOffsets: Map<HTMLElement, number> = new Map();

    // Initialize offsets
    tracks.forEach(track => {
      animationOffsets.set(track, 0);
    });

    const getComputedTranslateX = (element: HTMLElement): number => {
      const style = window.getComputedStyle(element);
      const matrix = new DOMMatrixReadOnly(style.transform);
      return matrix.m41;
    };

    const handleDragStart = (e: MouseEvent | TouchEvent) => {
      isDragging = true;
      carousel.classList.add('is-dragging');

      const clientX = 'touches' in e ? e.touches[0].clientX : e.clientX;
      startX = clientX;

      // Find which track is being dragged
      const target = e.target as HTMLElement;
      currentTrack = target.closest('.logo-track') as HTMLElement;

      if (currentTrack) {
        // Capture current position
        const currentTranslate = getComputedTranslateX(currentTrack);
        animationOffsets.set(currentTrack, currentTranslate);
        currentTrack.style.transform = `translateX(${currentTranslate}px)`;
      }
    };

    const handleDragMove = (e: MouseEvent | TouchEvent) => {
      if (!isDragging || !currentTrack) return;

      const clientX = 'touches' in e ? e.touches[0].clientX : e.clientX;
      const diff = clientX - startX;

      const baseOffset = animationOffsets.get(currentTrack) || 0;
      const newOffset = baseOffset + diff;

      currentTrack.style.transform = `translateX(${newOffset}px)`;
      dragOffset = diff;
    };

    const handleDragEnd = () => {
      if (!isDragging) return;

      isDragging = false;
      carousel.classList.remove('is-dragging');

      if (currentTrack) {
        // Update the stored offset
        const currentTranslate = getComputedTranslateX(currentTrack);
        animationOffsets.set(currentTrack, currentTranslate);

        // Remove inline style to let CSS animation resume from current position
        // We need to adjust the animation to continue from where we left off
        currentTrack.style.transform = '';
      }

      currentTrack = null;
      dragOffset = 0;
    };

    // Mouse events
    carousel.addEventListener('mousedown', handleDragStart);
    document.addEventListener('mousemove', handleDragMove);
    document.addEventListener('mouseup', handleDragEnd);

    // Touch events
    carousel.addEventListener('touchstart', handleDragStart, { passive: true });
    document.addEventListener('touchmove', handleDragMove, { passive: true });
    document.addEventListener('touchend', handleDragEnd);

    // Prevent default drag behavior on images
    carousel.addEventListener('dragstart', (e) => e.preventDefault());

    // Pause animation when not in viewport for performance
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          tracks.forEach((track) => {
            if (entry.isIntersecting) {
              track.style.animationPlayState = 'running';
            } else {
              track.style.animationPlayState = 'paused';
            }
          });
        });
      },
      { threshold: 0.1 }
    );
    observer.observe(carousel);
  });
</script>
